const e=["div.account__header button.logo-button","div.public-account-header a.logo-button","div.account-card a.logo-button","div.directory-card a.icon-button","div.detailed-status a.logo-button"],o=["div.account__header__tabs__name small","div.public-account-header__tabs__name small","div.detailed-status span.display-name__account","div.display-name > span"],i=/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/,a=/^(https?:\/\/(www\.)?.*\..*?\/)((@\w+(@([\w-]+\.)+?\w+)?)|explore|following|followers)\/?(\d+)?\/?$/,t=/^(https?:\/\/(www\.)?.*\..*?\/)((@\w+(@([\w-]+\.)+?\w+)?)|explore|public|public\/local)\/?(\d+)?\/?$/,n=/^(?:https?:\/\/(www\.)?.*\..*?\/)(@\w+(?:@([\w-]+\.)+?\w+)?)\/\d+\/?$/,s=/^[^@]*@(?<handle>\w+)(@(?<handledomain>([\w-]+\.)+?\w+))?\/?$/,l=!0,r="[FediFollow]",M=200,f="/api/v1/instance",d="/api/v1/statuses",c="/api/v2/search",u="/api/v1/accounts",w=500;var browser,chrome,h,p,m={};const v={fedifollow_homeinstance:null,fedifollow_alert:!1,fedifollow_mode:"blacklist",fedifollow_whitelist:null,fedifollow_blacklist:null,fedifollow_target:"_self",fedifollow_autoaction:!0,fedifollow_token:null,fedifollow_showfollows:!0,fedifollow_redirects:!0,fedifollow_enabledelay:!0};var g=window.location.href;function b(t){l&&console.log(r+" "+t)}!function(i){i.fn.DOMNodeAppear=function(e,o){var t=i(this);if(!(o=o||"function"==typeof t.selector&&t.selector))return!1;i(document).on("animationstart webkitAnimationStart oanimationstart MSAnimationStart",function(t){"nodeInserted"==t.originalEvent.animationName&&i(t.target).is(o)&&"function"==typeof e&&e(t)})},jQuery.fn.onAppear=jQuery.fn.DOMNodeAppear}(jQuery);var _=function(t){for(var e,o=window.location.search.substring(1).split("&"),i=0;i<o.length;i++)if((e=o[i].split("="))[0]===t)return void 0===e[1]||decodeURIComponent(e[1]);return!1};async function k(a,n,l){var t,e;return~n.indexOf(m.fedifollow_homeinstance)&&m.fedifollow_enabledelay&&(t=Date.now(),(e=t-h)<w&&await new Promise(t=>{setTimeout(function(){t()},w-e)}),h=t),new Promise(function(t,e){let o=new XMLHttpRequest;if(o.open(a,n),o.timeout=3e3,l)for(var i in l)o.setRequestHeader(i,l[i]);o.onload=function(){200<=this.status&&this.status<300?t(o.responseText):t(!1)},o.onerror=function(){e({status:this.status,statusText:o.statusText})},o.send()})}function y(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function A(t,e,o){return t.replace(new RegExp(y(e),"g"),o)}function T(t){var e;m.fedifollow_redirects?(m.fedifollow_alert&&alert("Redirecting..."),e=window.open(t,m.fedifollow_target),b("Redirected to "+t),e?e.focus():b("Could not open new window. Please allow popups for this website.")):b("Redirects disabled.")}async function O(t){if(m.fedifollow_autoaction){t=await k("POST","https://"+m.fedifollow_homeinstance+u+"/"+t+"/follow",m.tokenheader);if(t)return!(!(t=JSON.parse(t)).following&&!t.requested&&(b("Follow failed."),1))}else b("Auto-action disabled.")}async function S(t){if(m.fedifollow_autoaction){t=await k("POST","https://"+m.fedifollow_homeinstance+u+"/"+t+"/unfollow",m.tokenheader);if(t)return!(t=JSON.parse(t)).following&&!t.requested||(b("Unfollow failed."),!1)}else b("Auto-action disabled.")}async function x(t){if(m.fedifollow_autoaction){t=await k("POST","https://"+m.fedifollow_homeinstance+d+"/"+t+"/reblog",m.tokenheader);if(t)return!!JSON.parse(t).reblogged||(b("Boost failed."),!1)}else b("Auto-action disabled.")}async function R(t){if(m.fedifollow_autoaction){t=await k("POST","https://"+m.fedifollow_homeinstance+d+"/"+t+"/unreblog",m.tokenheader);if(t)return!JSON.parse(t).reblogged||(b("Unboost failed."),!1)}else b("Auto-action disabled.")}async function U(t){if(m.fedifollow_autoaction){t=await k("POST","https://"+m.fedifollow_homeinstance+d+"/"+t+"/favourite",m.tokenheader);if(t)return!!JSON.parse(t).favourited||(b("Favourite failed."),!1)}else b("Auto-action disabled.")}async function E(t){if(m.fedifollow_autoaction){t=await k("POST","https://"+m.fedifollow_homeinstance+d+"/"+t+"/unfavourite",m.tokenheader);if(t)return!JSON.parse(t).favourited||(b("Unfavourite failed."),!1)}else b("Auto-action disabled.")}async function q(t){if(m.fedifollow_autoaction){t=await k("POST","https://"+m.fedifollow_homeinstance+d+"/"+t+"/bookmark",m.tokenheader);if(t)return!!JSON.parse(t).bookmarked||(b("Bookmark failed."),!1)}else b("Auto-action disabled.")}async function F(t){if(m.fedifollow_autoaction){t=await k("POST","https://"+m.fedifollow_homeinstance+d+"/"+t+"/unbookmark",m.tokenheader);if(t)return!JSON.parse(t).bookmarked||(b("Unbookmark failed."),!1)}else b("Auto-action disabled.")}async function j(t){var e="https://"+m.fedifollow_homeinstance+u+"/relationships?";for(const n of t)e+="id[]="+n.toString()+"&";var o=await k("GET",e,m.tokenheader),i=Array(t.length).fill(!1);if(o)for(var o=JSON.parse(o),a=0;a<t.length;a++)for(account of o)account.id==t[a]&&account.following&&(i[a]=!0);return i}async function G(t){t=await k("GET","https://"+m.fedifollow_homeinstance+u+"/search?q="+t,m.tokenheader);return!(!t||!(t=JSON.parse(t))[0].id)&&[t[0].id,t[0].acct]}function W(t){return!!t&&new Promise(e=>{chrome.runtime.sendMessage({url:t},function(t){e(t||!1)})})}async function N(t,e){var o,i,a,n,l,r=await k("GET","https://"+m.fedifollow_homeinstance+c+"/?q="+t+"&resolve=true&limit=10",m.tokenheader);return r?((r=JSON.parse(r)).accounts.length||r.statuses.length||!s.test(t)||(n=t.match(s)).groups.handle&&n.groups.handledomain&&(t="https://"+n.groups.handledomain+"/@"+n.groups.handle,r=await k("GET","https://"+m.fedifollow_homeinstance+c+"/?q="+t+"&resolve=true&limit=10",m.tokenheader),r=JSON.parse(r)),r.accounts.length&&!r.statuses.length?(l="https://"+m.fedifollow_homeinstance+"/@"+r.accounts[0].acct,"follow"==e?o=await O(r.accounts[0].id):"unfollow"==e&&(o=await S(r.accounts[0].id))):!r.accounts.length&&r.statuses.length&&(n=r.statuses[0],l="https://"+m.fedifollow_homeinstance+"/@"+n.account.acct+"/"+n.id,"boost"==e?o=await x(n.id):"favourite"==e?o=await U(n.id):"bookmark"==e?o=await q(n.id):"unboost"==e?o=await R(n.id):"unfavourite"==e?o=await E(n.id):"unbookmark"==e&&(o=await F(n.id)),i=n.favourited,a=n.reblogged,bookmarked=n.bookmarked),!!l&&[l,o,i,a,bookmarked]):(b("API call failed..."),!1)}function C(t,e,o){var i,a,n=$(t).toggleClass(o).hasClass(o);for(i of e)n?$(t).css(i[0],i[2]):"!remove"==i[1]?(a=A($(t).attr("style"),i[0]+": "+i[2]+";",""),$(t).attr("style",a)):$(t).css(i[0],i[1])}function z(t,e,o,i){return o=o&&o.join(","),new MutationObserver(function(t){t.forEach(function(t){var e=t.addedNodes;null!==e&&$(e).each(function(){(!o||$(this).is(o))&&i(this,t)})})}).observe($(t)[0],e)}function H(t){for(const e of t)if($(e).length)return $(e).text().trim();return!1}async function B(){$(document).DOMNodeAppear(function(t){$(t.target).find("button:has(i.fa-reply").click()},"div.detailed-status__action-bar")}async function P(){async function r(t,e){var o=function(t){var e=!1;$(t.currentTarget).children("i.fa-retweet").length?e=$(t.currentTarget).children("i.fa-retweet").hasClass("fediactive")?"unboost":"boost":$(t.currentTarget).children("i.fa-star").length?e=$(t.currentTarget).hasClass("fediactive")?"unfavourite":"favourite":$(t.currentTarget).children("i.fa-bookmark").length?e=$(t.currentTarget).hasClass("fediactive")?"unbookmark":"bookmark":$(t.currentTarget).attr("href")&&(~$(t.currentTarget).attr("href").indexOf("type=reblog")?e=$(t.currentTarget).hasClass("fediactive")?"unboost":"boost":~$(t.currentTarget).attr("href").indexOf("type=favourite")&&(e=$(t.currentTarget).hasClass("fediactive")?"unfavourite":"favourite"));return e}(e);if(o){t=await N(t,o);if(t)return t[1]&&("boost"==o||"unboost"==o?C($(e.currentTarget).find("i"),[["color","!remove","rgb(140, 141, 255)"],["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive"):C($(e.currentTarget),"favourite"==o||"unfavourite"==o?[["color","!remove","rgb(202, 143, 4)"]]:[["color","!remove","rgb(255, 80, 80)"]],"fediactive")),t[0];b("Could not resolve action on home instance.")}else b("Could not determine action.")}async function o(t){var e,o,i,a,n=location.protocol+"//"+location.hostname+"/",l=function(t){var e,[o,i]=[!1,!1];return $(t).find("span.display-name__account").length&&(i=$(t).find("span.display-name__account").text().trim()),$(t).is(".detailed-status__wrapper")?o=g.split("?")[0].split("/")[4]:$(t).find("a.status__relative-time").attr("href")?o=(e=$(t).find("a.status__relative-time").attr("href").split("?")[0]).startsWith("http")?e.split("/")[4]:e.split("/")[2]:$(t).find("a.detailed-status__datetime").attr("href")?o=(e=$(t).find("a.detailed-status__datetime").attr("href").split("?")[0]).startsWith("http")?e.split("/")[4]:e.split("/")[2]:$(t).attr("data-id")?o=$(t).attr("data-id").split("-").slice(-1)[0]:$(t).closest("article[data-id], div[data-id]").length?o=$(t).closest("article[data-id], div[data-id]")[0].attr("data-id").split("-").slice(-1)[0]:$(t).find("a.modal-button").length&&(o=(e=$(t).find("a.modal-button").attr("href").split("?")[0]).startsWith("http")?e.split("/")[4]:e.split("/")[2]),[o,i]}($(t));l?((o=l[1].match(s)).groups.handledomain?~location.hostname.indexOf(o.groups.handledomain)?(clearedHandle=l[1].split("@"+o.groups.handledomain)[0],n+=clearedHandle+"/"+l[0]):(e=await W(location.protocol+"//"+location.hostname+"/"+l[1]+"/"+l[0]),n=e||"https://"+o.groups.handledomain+"/@"+o.groups.handle+"/"+l[0]):n+=l[1]+"/"+l[0],n?(resolveAndAction=await N(n,null))?(e=$(t).find("button:has(i.fa-star), a.icon-button:has(i.fa-star)"),o=$(t).find("button:has(i.fa-retweet), a.icon-button:has(i.fa-retweet)"),l=$(t).find("button:has(i.fa-bookmark)"),t=$(t).find("button:has(i.fa-reply)"),$(l).removeClass("disabled").removeAttr("disabled"),resolveAndAction[2]&&!$(e).hasClass("fediactive")&&C($(e),[["color","!remove","rgb(202, 143, 4)"]],"fediactive"),resolveAndAction[3]&&!$(o).find("i.fediactive").length&&C($(o).find("i"),[["color","!remove","rgb(140, 141, 255)"],["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive"),resolveAndAction[4]&&!$(l).hasClass("fediactive")&&C($(l),[["color","!remove","rgb(255, 80, 80)"]],"fediactive"),$(t).on("click",function(t){t.preventDefault(),t.stopImmediatePropagation(),T(resolveAndAction[0]+"?fedireply")}),i=0,$([e,o,l]).each(function(){$(this).on("click",async function(t){t.preventDefault(),t.stopImmediatePropagation(),1==++i?a=setTimeout(async function(){await r(n,t),i=0},350):(clearTimeout(a),(url=await r(n,t))&&T(url),i=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})})):b("Failed to resolve: "+n):b("Could not identify a post URI for home resolving.")):b("Could not get toot data.")}t.test(g.split("?")[0])?n.test(g)?($(document).find("div.detailed-status__wrapper").each(function(){o($(this))}),$(document).DOMNodeAppear(async function(t){o($(t.target))},"div.status, div.detailed-status__wrapper")):($(document).ready(async function(){var i=$("body").html();await new Promise(e=>{var o=setInterval(function(){var t=$("body").html();t==i?(changing=!1,e(!0),clearInterval(o)):i=t},100)}),$(document).find("div.entry > div.status").each(function(){o($(this))})}),$(document).DOMNodeAppear(async function(t){var t=$(t.target),i=$("body").html();await new Promise(e=>{var o=setInterval(function(){var t=$("body").html();t==i?(changing=!1,e(!0),clearInterval(o)):i=t},100)}),t.find("div.status").each(async function(){document.body.contains($(this)[0])&&o($(this))}),z(t,{subtree:!0,childList:!0},["div.status"],function(t,e){o($(t))})},"article, div.entry > div.status")):b("There are no toots on this site")}async function I(){var t;a.test(g.split("?")[0])?(t=e.join(","),$(document).DOMNodeAppear(async function(t){!async function(a){var t,n,l,r,s="follow";if($(a).closest("div.account-card").length)t=$(a).closest("div.account-card").find("div.display-name > span").text().trim();else for(const e of o)if($(e).length){t=$(e).text().trim();break}t&&((n=await G(t))?(m.fedifollow_showfollows&&(await j([n[0]]))[0]&&($(a).text("Unfollow"),s="unfollow"),l=0,$(a).off(),$(a).unbind(),$(a).on("click",async function(t){var e,o,i;t.preventDefault(),t.stopImmediatePropagation(),1==++l?r=setTimeout(async function(){"follow"==s?await O(n[0])&&($(a).text("Unfollow"),s="unfollow"):await S(n[0])&&($(a).text("Follow"),s="follow"),l=0},350):(clearTimeout(r),"follow"==s?await O(n[0])&&($(a).text("Unfollow"),s="unfollow",e=!0):await S(n[0])&&($(a).text("Follow"),s="follow",e=!0),e?(o=$(a).text(),i="https://"+m.fedifollow_homeinstance+"/@"+n[1],$(a).text("Redirecting..."),setTimeout(function(){T(i),$(a).text(o)},1e3)):b("Action failed."),l=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})):b("Could not resolve user home ID."))}($(t.target))},t)):b("Not a profile URL.")}async function D(){setTimeout(function(){g!=window.location.href&&(g=window.location.href,I(),P()),D()},300)}function J(t){var e,o=[];for(e of t.split(/\r?\n/))e=e.trim(),i.test(e)?o.push(e):b("Removed invalid domain "+e+" from blacklist/whitelist.");return[...new Set(o)]}function L(){if(null==m.fedifollow_homeinstance||!m.fedifollow_homeinstance)return b("Mastodon home instance is not set."),!1;if(!m.fedifollow_token)return b("No API token available. Are you logged in to your home instance? If yes, wait for 1-2 minutes and reload page."),!1;if(m.tokenheader={Authorization:"Bearer "+m.fedifollow_token},!i.test(m.fedifollow_homeinstance))return b("Instance setting is not a valid domain name."),!1;if($.inArray(m.fedifollow_mode,["blacklist","whitelist"])<0&&(m.fedifollow_mode="blacklist"),$.inArray(m.fedifollow_target,["_blank","_self"])<0&&(m.fedifollow_target="_blank"),"whitelist"==m.fedifollow_mode){if(m.fedifollow_whitelist=J(m.fedifollow_whitelist),m.fedifollow_whitelist.length<1)return b("Whitelist is empty or invalid."),!1}else m.fedifollow_blacklist=J(m.fedifollow_blacklist);return!0}async function Q(){if(location.hostname!=m.fedifollow_homeinstance||(p=_("fedireply"))){if("whitelist"==m.fedifollow_mode){if($.inArray(location.hostname,m.fedifollow_whitelist)<0)return b("Current site is not in whitelist."),!1}else if(-1<$.inArray(location.hostname,m.fedifollow_blacklist))return b("Current site is in blacklist."),!1;var t=await k("GET",location.protocol+"//"+location.hostname+f,null);if(t)if(JSON.parse(t).uri)return!0;b("Does not look like a Mastodon instance.")}else b("Current site is your home instance.");return!1}async function X(){(m=await(browser||chrome).storage.local.get(v))?L()&&(await Q()?(p?B:(I(),P(),D))():b("Will not process this site.")):b("Could not load settings.")}X();