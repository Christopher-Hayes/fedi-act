const a=["div.account__header button.logo-button","div.public-account-header a.logo-button","div.account-card a.logo-button","div.directory-card a.icon-button","div.detailed-status a.logo-button","button.remote-button","div.account__header button.button--follow"],c=["div.account__header__tabs__name small","div.public-account-header__tabs__name small","div.detailed-status span.display-name__account","div.display-name > span","a.user-screen-name","div.profile-info-panel small"],i=/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/,R=/^(?<domain>https?:\/\/(?:\.?[a-z0-9-]+)+(?:\.[a-z]+){1})?\/?@(?<handle>\w+)(?:@(?<handledomain>(?:[\w-]+\.)+?\w+))?(?:\/(?<tootid>\d+))?\/?$/,D=/^(?<domain>https?:\/\/(?:\.?[a-z0-9-]+)+(?:\.[a-z]+){1})(?:\/users\/)(?<handle>\w+)(?:(?:\/statuses\/)(?<tootid>\d+))?\/?$/,e=!1,n="[FediAct]",o="/api/v1/instance",r="/api/v1/statuses",s="/api/v2/search",d="/api/v1/accounts",l=500,u=200;var browser,chrome,f,h,P={};const t={fediact_homeinstance:null,fediact_alert:!1,fediact_mode:"blacklist",fediact_whitelist:null,fediact_blacklist:null,fediact_target:"_self",fediact_autoaction:!0,fediact_token:null,fediact_showfollows:!0,fediact_redirects:!0,fediact_enabledelay:!0,fediact_hidemuted:!1,fediact_mutesblocks:[],fediact_domainblocks:[]};var[S,p,m]=[[],[],[]];function I(t){e&&console.log(n+" "+t)}function g(){return new Promise(function(e){var t;$(document).find("script#initial-state").length?(t=$(document).find("script#initial-state").first(),JSON.parse($(t).text()).meta.access_token&&e(!0)):$(document).DOMNodeAppear(function(t){t=$(t.target);JSON.parse($(t).text()).meta.access_token&&e(!0)},"script#initial-state"),e(!1)})}!function(i){i.fn.DOMNodeAppear=function(e,a){if(!a)return!1;i(document).on("animationstart webkitAnimationStart oanimationstart MSAnimationStart",function(t){"nodeInserted"==t.originalEvent.animationName&&i(t.target).is(a)&&"function"==typeof e&&e(t)})},jQuery.fn.onAppear=jQuery.fn.DOMNodeAppear}(jQuery);var v=function(t){for(var e,a=window.location.search.substring(1).split("&"),i=0;i<a.length;i++)if((e=a[i].split("="))[0]===t)return void 0===e[1]||decodeURIComponent(e[1]);return!1};async function _(i,n,o){var t,e;return~n.indexOf(P.fediact_homeinstance)&&P.fediact_enabledelay&&(t=Date.now(),(e=t-f)<l&&await new Promise(t=>{setTimeout(function(){t()},l-e)}),f=t),new Promise(function(t){let e=new XMLHttpRequest;if(e.open(i,n),e.timeout=3e3,o)for(var a in o)e.setRequestHeader(a,o[a]);e.onload=function(){200<=this.status&&this.status<300?t(e.responseText):t(!1)},e.onerror=function(){I("Request to "+n+" failed."),t(!1)},e.send()})}function b(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function w(t,e,a){return t.replace(new RegExp(b(e),"g"),a)}function M(t){var e;P.fediact_redirects?(P.fediact_alert&&alert("Redirecting..."),e=window.open(t,P.fediact_target),I("Redirected to "+t),e?e.focus():I("Could not open new window. Please allow popups for this website.")):I("Redirects disabled.")}async function z(t,e){var a,i;switch(e){case"follow":a="https://"+P.fediact_homeinstance+d+"/"+t+"/follow",i=function(t){return t.following||t.requested};break;case"boost":a="https://"+P.fediact_homeinstance+r+"/"+t+"/reblog",i=function(t){return t.reblogged};break;case"favourite":a="https://"+P.fediact_homeinstance+r+"/"+t+"/favourite",i=function(t){return t.favourited};break;case"bookmark":a="https://"+P.fediact_homeinstance+r+"/"+t+"/bookmark",i=function(t){return t.bookmarked};break;case"unfollow":a="https://"+P.fediact_homeinstance+d+"/"+t+"/unfollow",i=function(t){return!t.following&&!t.requested};break;case"unboost":a="https://"+P.fediact_homeinstance+r+"/"+t+"/unreblog",i=function(t){return!t.reblogged};break;case"unfavourite":a="https://"+P.fediact_homeinstance+r+"/"+t+"/unfavourite",i=function(t){return!t.favourited};break;case"unbookmark":a="https://"+P.fediact_homeinstance+r+"/"+t+"/unbookmark",i=function(t){return!t.bookmarked};break;default:I("No valid action specified.")}if(a){var n=await _("POST",a,P.tokenheader);if(n&&i(JSON.parse(n)))return!0}I(e+" action failed.")}async function k(t){var e="https://"+P.fediact_homeinstance+d+"/relationships?";for(const o of t)e+="id[]="+o.toString()+"&";var a=await _("GET",e,P.tokenheader),i=Array(t.length).fill(!1);if(a)for(var a=JSON.parse(a),n=0;n<t.length;n++)for(account of a)account.id==t[n]&&(account.following||account.requested)&&(i[n]=!0);return i}function q(t){if((t=t.startsWith("@")?t.slice(1):t).split("@").length-1==0&&(t=t+"@"+P.fediact_exturi),P.fediact_mutesblocks.includes(t)||P.fediact_domainblocks.includes(t.split("@")[1]))return!0}async function T(t){t=await _("GET","https://"+P.fediact_homeinstance+d+"/search?q="+t+"&resolve=true&limit=1",P.tokenheader);return!(!t||!(t=JSON.parse(t))[0].id)&&[t[0].id,t[0].acct]}async function E(t){var t=await _("GET","https://"+P.fediact_homeinstance+s+"/?q="+t+"&resolve=true&limit=1",P.tokenheader);return!!t&&!((t=JSON.parse(t)).accounts.length||!t.statuses.length)&&[(t=t.statuses[0]).account.acct,t.id,t.reblogged,t.favourited,t.bookmarked]}function W(t){return!!t&&new Promise(async function(e){try{await chrome.runtime.sendMessage({url:t},function(t){e(t||!1)})}catch(t){I(t),I("Reloading page, extension likely got updated or reloaded."),location.reload()}})}function U(t,e,a){var i,n,o=$(t).toggleClass(a).hasClass(a);for(i of e)o?$(t).css(i[0],i[2]):"!remove"==i[1]?(n=w($(t).attr("style"),i[0]+": "+i[2]+";",""),$(t).attr("style",n)):$(t).css(i[0],i[1])}function L(t){for(var e=0;e<S.length;e++)if(S[e][0]==t)return e;return!1}function J(t){S.push(t);t=S.length-u;return(S=0<t?S.splice(0,t):S).length-1}async function A(){$(document).DOMNodeAppear(function(t){$(t.target).find("button:has(i.fa-reply), button:has(i.fa-reply-all)").click()},"div.detailed-status__action-bar")}async function C(){function N(t){var e;return!t.startsWith("http")||(e=new URL(t),location.hostname==e.hostname)?[!1,(t=t.split("/")).pop()||t.pop()]:[!0,t]}async function e(e){$(e).is("div.detailed-status")&&$(e).closest("div.focusable").length&&(e=$(e).closest("div.focusable"));var t=function(t){if($(t).find("span.display-name__account").length)return $(t).find("span.display-name__account").first().text().trim()}($(e));if(!function(t,e){if(P.fediact_hidemuted){var a,i,n=[],o=($(t).siblings(".status__prepend").length&&(a=$(t).siblings(".status__prepend").first(),$(a).find("a").attr("href"))&&n.push($(a).find("a").attr("href").split("?")[0]),$(t).find("span.h-card").each(function(){n.push($(this).find("a").attr("href").split("?")[0])}),[]);for(i of n){var r,s=i.split("/"),s=(s=s.pop()||s.pop()).slice(1);i.startsWith("http")&&(r=new URL(i)).hostname!=P.fediact_exturi&&r.hostname!=location.hostname?o.push(s+"@"+r.hostname):o.push(s+"@"+P.fediact_exturi)}return o.some(t=>P.fediact_mutesblocks.includes(t))||q(e)||o.some(t=>P.fediact_domainblocks.includes(t.split("@")[1]))?($(t).hide(),a&&$(a).hide(),1):void 0}}(e,t)){var a=function(t){if($(t).is(".detailed-status__wrapper"))return(e=window.location.href.split("?")[0].split("/")).pop()||e.pop();if($(t).attr("data-id"))return $(t).attr("data-id").split("-").slice(-1)[0];if($(t).closest("article[data-id], div[data-id]").length)return $(t).closest("article[data-id], div[data-id]").first().attr("data-id").split("-").slice(-1)[0];if($(t).find("a.icon-button:has(i.fa-star), a.detailed-status__link:has(i.fa-star)").length){var e=$(t).find("a.icon-button:has(i.fa-star), a.detailed-status__link:has(i.fa-star)").first();if($(e).attr("href")){t=$(e).attr("href");if(~t.indexOf("interact/"))return(e=t.split("?")[0].split("/")).pop()||e.pop()}}}($(e)),[i,n]=(i=$(e),$(i).find("a.status__relative-time").length?N($(i).find("a.status__relative-time").first().attr("href").split("?")[0]):$(i).find("a.detailed-status__datetime").length?N($(i).find("a.detailed-status__datetime").first().attr("href").split("?")[0]):$(i).find("a.modal-button").length?N($(i).find("a.modal-button").first().attr("href").split("?")[0]):[!1,void 0]),o=a||n;if(o){var r=[],s=L(o),c=$(e).find("button:has(i.fa-star), a.icon-button:has(i.fa-star), a.detailed-status__link:has(i.fa-star)").first(),d=$(e).find("button:has(i.fa-retweet), a.icon-button:has(i.fa-retweet), a.detailed-status__link:has(i.fa-retweet)").first(),l=$(e).find("button:has(i.fa-bookmark)").first(),u=$(e).find("button:has(i.fa-reply), button:has(i.fa-reply-all), a.icon-button:has(i.fa-reply), a.icon-button:has(i.fa-reply-all)").first();async function f(t,e){if(!P.fediact_autoaction)return I("Auto-action disabled."),!0;i=e,a=!1,$(i.currentTarget).children("i.fa-retweet").length?a=$(i.currentTarget).children("i.fa-retweet").hasClass("fediactive")?"unboost":"boost":$(i.currentTarget).children("i.fa-star").length?a=$(i.currentTarget).hasClass("fediactive")?"unfavourite":"favourite":$(i.currentTarget).children("i.fa-bookmark").length?a=$(i.currentTarget).hasClass("fediactive")?"unbookmark":"bookmark":$(i.currentTarget).attr("href")&&(~$(i.currentTarget).attr("href").indexOf("type=reblog")?a=$(i.currentTarget).hasClass("fediactive")?"unboost":"boost":~$(i.currentTarget).attr("href").indexOf("type=favourite")&&(a=$(i.currentTarget).hasClass("fediactive")?"unfavourite":"favourite"));var a,i=a;if(i){if(await z(t,i))return"boost"==i||"unboost"==i?(U($(e.currentTarget),[["color","!remove","rgb(140, 141, 255)"]],"fediactive"),U($(e.currentTarget).find("i"),[["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive"),s&&(S[s][3]=!S[s][3])):"favourite"==i||"unfavourite"==i?(U($(e.currentTarget),[["color","!remove","rgb(202, 143, 4)"]],"fediactive"),U($(e.currentTarget).find("i"),[["animation","spring-rotate-out 1s linear","spring-rotate-in 1s linear"]],"fediactive"),s&&(S[s][4]=!S[s][4])):(U($(e.currentTarget),[["color","!remove","rgb(255, 80, 80)"]],"fediactive"),s&&(S[s][5]=!S[s][5])),!0;I("Could not execute action on home instance.")}else I("Could not determine action.")}function h(t){$(e).find(".feditriggered").remove(),t[1]?($(l).removeClass("disabled").removeAttr("disabled"),t[4]&&!$(c).hasClass("fediactive")&&(U($(c),[["color","!remove","rgb(202, 143, 4)"]],"fediactive"),U($(c).find("i"),[["animation","spring-rotate-out 1s linear","spring-rotate-in 1s linear"]],"fediactive")),t[3]&&!$(d).find("i.fediactive").length&&(U($(d),[["color","!remove","rgb(140, 141, 255)"]],"fediactive"),U($(d).find("i"),[["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive")),t[5]&&!$(l).hasClass("fediactive")&&U($(l),[["color","!remove","rgb(255, 80, 80)"]],"fediactive")):$("<span class='feditriggered' style='color: orange; padding-right: 10px; padding-left: 10px'>Unresolved</span>").insertAfter($(c))}function p(i){$(u).on("click",function(t){t.preventDefault(),t.stopImmediatePropagation(),M(i[6]+"?fedireply")}),$([c,d,l]).each(function(){var e,a=0;$(this).on("click",async function(t){t.preventDefault(),t.stopImmediatePropagation(),1==++a?e=setTimeout(async function(){await f(i[2],t)||I("Action failed."),a=0},350):(clearTimeout(e),await f(i[2],t)?M(i[6]):I("Action failed."),a=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})})}if(s){var m=S[s];h(m),m[1]&&p(m)}else{if(i&&r.push(n),t){var g,v,_,b=t.match(R),[w,k]=[!1,!1],y=(!b.groups.handledomain||~location.hostname.indexOf(b.groups.handledomain)||(w=!0),[a]);i||y.push(n);for(g of y=y.filter((t,e)=>void 0!==t&&y.indexOf(t)==e))w?k||((v=await W(location.protocol+"//"+location.hostname+"/"+t+"/"+g))&&(k=!0,r.push(v),D.test(v)?(_=v.match(D)).groups.handle&&_.groups.tootid&&_.groups.domain&&r.push(_.groups.domain+"/@"+_.groups.handle+"/"+_.groups.tootid):R.test(v)&&(_=v.match(R)).groups.handle&&_.groups.tootid&&_.groups.domain&&r.push(_.groups.domain+"/users/"+_.groups.handle+"/statuses/"+_.groups.tootid)),r.push(location.protocol+"//"+location.hostname+"/"+t+"/"+g)):(r.push(location.protocol+"//"+location.hostname+"/users/"+b.groups.handle+"/statuses/"+g),r.push(location.protocol+"//"+location.hostname+"/@"+b.groups.handle+"/"+g))}if(r.length){var x,T,A,C,O=!1;for(x of r=r.filter((t,e)=>r.indexOf(t)==e))O||(T=await E(x))&&(O=!0,A="https://"+P.fediact_homeinstance+"/@"+T[0]+"/"+T[1],C=[o,...T,A,!0]);O?(s=J(C),h(C),p(C)):(I("Failed to resolve: "+r),s=J([o,!1]),h([o,!1]))}else I("Could not identify a post URI for home resolving."),s=J([o,!1]),h([o,!1])}}else I("Could not get toot data.")}}$(document).DOMNodeAppear(async function(t){m.includes($(t.target).get(0))||(m.push($(t.target).get(0)),e($(t.target)))},"div.status, div.detailed-status"),$(document).find("div.status, div.detailed-status").each(function(){m.includes($(this).get(0))||(m.push($(this).get(0)),e($(this)))})}async function O(){async function e(i){var t,n,o,r,e="follow";async function s(t){return P.fediact_autoaction?(t=await z(t,e),"follow"==e&&t?($(i).text("Unfollow"),e="unfollow",!0):"unfollow"==e&&t?($(i).text("Follow"),e="follow",!0):void 0):(I("Auto-action disabled."),!0)}if($(i).closest("div.account-card").length)t=$(i).closest("div.account-card").find("div.display-name > span").text().trim();else for(const a of c)if($(a).length){(t=$(a).text().trim()).split("@").length-1==1&&(t=t+"@"+P.fediact_exturi);break}t&&!p.includes(t)&&((n=await T(t))?(p.push(t),P.fediact_showfollows&&(await k([n[0]]))[0]&&($(i).text("Unfollow"),e="unfollow"),o=0,$(i).on("click",async function(t){var e,a;t.preventDefault(),t.stopImmediatePropagation(),1==++o?r=setTimeout(async function(){s(n[0]),o=0},350):(clearTimeout(r),await s(n[0])?(e=$(i).text(),a="https://"+P.fediact_homeinstance+"/@"+n[1],$(i).text("Redirecting..."),setTimeout(function(){M(a),$(i).text(e)},1e3)):I("Action failed."),o=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})):I("Could not resolve user home ID."))}var t=a.join(",");$(document).DOMNodeAppear(async function(t){m.includes($(t.target).get(0))||(m.push($(t.target).get(0)),e($(t.target)))},t),$(document).find(t).each(function(){m.includes($(this).get(0))||(m.push($(this).get(0)),e($(this)))})}function y(t){var e,a=[];for(e of t.split(/\r?\n/))(e=e.trim()).length&&(i.test(e)?a.push(e):I("Removed invalid domain "+e+" from blacklist/whitelist."));return[...new Set(a)]}function N(){if(null==P.fediact_homeinstance||!P.fediact_homeinstance)return I("Mastodon home instance is not set."),!1;if(!P.fediact_token)return I("No API token available. Are you logged in to your home instance? If yes, wait for 1-2 minutes and reload page."),!1;if(P.tokenheader={Authorization:"Bearer "+P.fediact_token},!i.test(P.fediact_homeinstance))return I("Instance setting is not a valid domain name."),!1;if("whitelist"==P.fediact_mode){if(P.fediact_whitelist=y(P.fediact_whitelist),P.fediact_whitelist.length<1)return I("Whitelist is empty or invalid."),!1}else P.fediact_blacklist=y(P.fediact_blacklist);return!0}async function j(){if(location.hostname!=P.fediact_homeinstance||(h=v("fedireply"))){if("whitelist"==P.fediact_mode){if($.inArray(location.hostname,P.fediact_whitelist)<0)return I("Current site is not in whitelist."),!1}else if(-1<$.inArray(location.hostname,P.fediact_blacklist))return I("Current site is in blacklist."),!1;var t=await _("GET",location.protocol+"//"+location.hostname+o,null);if(t){t=JSON.parse(t).uri;if(t){if(t.startsWith("http")?(t=new URL(t),P.fediact_exturi=t.hostname):P.fediact_exturi=t,!await g())return!0;I("Already logged in to this external instance.")}}}else I("Current site is your home instance.");return!1}async function F(){chrome.runtime.onMessage.addListener(async function(t,e,a){t.urlchanged&&(S=[],p=[],m=[],await x()||location.reload()),t.updatedfedisettings&&location.reload()});try{return await chrome.runtime.sendMessage({running:!0}),!0}catch(t){I(t)}return!1}function x(){return new Promise(async function(e){try{P=await(browser||chrome).storage.local.get(t)}catch(t){I(t),e(!1)}P&&N()?e(!0):e(!1)})}async function G(){await x()?await j()?h?A():F()?(O(),C()):I("Failed to initialize background script."):I("Will not process this site."):I("Could not load settings.")}G();