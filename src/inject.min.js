const i=["div.account__header button.logo-button","div.public-account-header a.logo-button","div.account-card a.logo-button","div.directory-card a.icon-button","div.detailed-status a.logo-button"],c=["div.account__header__tabs__name small","div.public-account-header__tabs__name small","div.detailed-status span.display-name__account","div.display-name > span"],n=/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/,h=/^[^@]*@(?<handle>\w+)(@(?<handledomain>([\w-]+\.)+?\w+))?(\/(?<tootid>\d+))?\/?$/,e=!0,a="[FediAct]",J=200,o="/api/v1/instance",r="/api/v1/statuses",s="/api/v2/search",l="/api/v1/accounts",d=500,f=200;var browser,chrome,u,p,m={};const t={fediact_homeinstance:null,fediact_alert:!1,fediact_mode:"blacklist",fediact_whitelist:null,fediact_blacklist:null,fediact_target:"_self",fediact_autoaction:!0,fediact_token:null,fediact_showfollows:!0,fediact_redirects:!0,fediact_enabledelay:!0};var v=[];function g(t){e&&console.log(a+" "+t)}!function(i){i.fn.DOMNodeAppear=function(e,a){var t=i(this);if(!(a=a||"function"==typeof t.selector&&t.selector))return!1;i(document).on("animationstart webkitAnimationStart oanimationstart MSAnimationStart",function(t){"nodeInserted"==t.originalEvent.animationName&&i(t.target).is(a)&&"function"==typeof e&&e(t)})},jQuery.fn.onAppear=jQuery.fn.DOMNodeAppear}(jQuery);var b=function(t){for(var e,a=window.location.search.substring(1).split("&"),i=0;i<a.length;i++)if((e=a[i].split("="))[0]===t)return void 0===e[1]||decodeURIComponent(e[1]);return!1};async function w(i,n,o){var t,e;return~n.indexOf(m.fediact_homeinstance)&&m.fediact_enabledelay&&(t=Date.now(),(e=t-u)<d&&await new Promise(t=>{setTimeout(function(){t()},d-e)}),u=t),new Promise(function(t){let e=new XMLHttpRequest;if(e.open(i,n),e.timeout=3e3,o)for(var a in o)e.setRequestHeader(a,o[a]);e.onload=function(){200<=this.status&&this.status<300?t(e.responseText):t(!1)},e.onerror=function(){g("Request to "+n+" failed."),t(!1)},e.send()})}function _(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function k(t,e,a){return t.replace(new RegExp(_(e),"g"),a)}function y(t){var e;m.fediact_redirects?(m.fediact_alert&&alert("Redirecting..."),e=window.open(t,m.fediact_target),g("Redirected to "+t),e?e.focus():g("Could not open new window. Please allow popups for this website.")):g("Redirects disabled.")}async function T(t){if(m.fediact_autoaction){t=await w("POST","https://"+m.fediact_homeinstance+l+"/"+t+"/follow",m.tokenheader);if(t)return!(!(t=JSON.parse(t)).following&&!t.requested&&(g("Follow failed."),1))}else g("Auto-action disabled.")}async function O(t){if(m.fediact_autoaction){t=await w("POST","https://"+m.fediact_homeinstance+l+"/"+t+"/unfollow",m.tokenheader);if(t)return!(t=JSON.parse(t)).following&&!t.requested||(g("Unfollow failed."),!1)}else g("Auto-action disabled.")}async function A(t){if(m.fediact_autoaction){t=await w("POST","https://"+m.fediact_homeinstance+r+"/"+t+"/reblog",m.tokenheader);if(t)return!!JSON.parse(t).reblogged||(g("Boost failed."),!1)}else g("Auto-action disabled.")}async function S(t){if(m.fediact_autoaction){t=await w("POST","https://"+m.fediact_homeinstance+r+"/"+t+"/unreblog",m.tokenheader);if(t)return!JSON.parse(t).reblogged||(g("Unboost failed."),!1)}else g("Auto-action disabled.")}async function x(t){if(m.fediact_autoaction){t=await w("POST","https://"+m.fediact_homeinstance+r+"/"+t+"/favourite",m.tokenheader);if(t)return!!JSON.parse(t).favourited||(g("Favourite failed."),!1)}else g("Auto-action disabled.")}async function N(t){if(m.fediact_autoaction){t=await w("POST","https://"+m.fediact_homeinstance+r+"/"+t+"/unfavourite",m.tokenheader);if(t)return!JSON.parse(t).favourited||(g("Unfavourite failed."),!1)}else g("Auto-action disabled.")}async function C(t){if(m.fediact_autoaction){t=await w("POST","https://"+m.fediact_homeinstance+r+"/"+t+"/bookmark",m.tokenheader);if(t)return!!JSON.parse(t).bookmarked||(g("Bookmark failed."),!1)}else g("Auto-action disabled.")}async function P(t){if(m.fediact_autoaction){t=await w("POST","https://"+m.fediact_homeinstance+r+"/"+t+"/unbookmark",m.tokenheader);if(t)return!JSON.parse(t).bookmarked||(g("Unbookmark failed."),!1)}else g("Auto-action disabled.")}async function M(t){var e="https://"+m.fediact_homeinstance+l+"/relationships?";for(const o of t)e+="id[]="+o.toString()+"&";var a=await w("GET",e,m.tokenheader),i=Array(t.length).fill(!1);if(a)for(var a=JSON.parse(a),n=0;n<t.length;n++)for(account of a)account.id==t[n]&&account.following&&(i[n]=!0);return i}async function U(t,e){var a;switch(e){case"boost":a=await A(t);break;case"favourite":a=await x(t);break;case"bookmark":a=await C(t);break;case"unboost":a=await S(t);break;case"unfavourite":a=await N(t);break;case"unbookmark":a=await P(t);break;default:g("No valid action specified.")}return a}async function q(t){t=await w("GET","https://"+m.fediact_homeinstance+l+"/search?q="+t+"&resolve=true&limit=1",m.tokenheader);return!(!t||!(t=JSON.parse(t))[0].id)&&[t[0].id,t[0].acct]}async function E(t){var t=await w("GET","https://"+m.fediact_homeinstance+s+"/?q="+t+"&resolve=true&limit=1",m.tokenheader);return t?!(t=JSON.parse(t)).accounts.length&&t.statuses.length?[(t=t.statuses[0]).account.acct,t.id,t.reblogged,t.favourited,t.bookmarked]:(g("No toot result found."),!1):(g("API call failed..."),!1)}function F(t){return!!t&&new Promise(async function(e){try{await chrome.runtime.sendMessage({url:t},function(t){e(t||!1)})}catch(t){g(t),g("Reloading page, extension likely got updated."),location.reload()}})}function R(t,e,a){var i,n,o=$(t).toggleClass(a).hasClass(a);for(i of e)o?$(t).css(i[0],i[2]):"!remove"==i[1]?(n=k($(t).attr("style"),i[0]+": "+i[2]+";",""),$(t).attr("style",n)):$(t).css(i[0],i[1])}function z(t){for(const e of t)if($(e).length)return $(e).text().trim();return!1}function j(t){for(var e=0;e<v.length;e++)if(v[e][0]==t)return e;return!1}function D(t){v.push(t);t=v.length-f;0<t&&(v=v.splice(0,t))}async function G(){$(document).DOMNodeAppear(function(t){$(t.target).find("button:has(i.fa-reply), button:has(i.fa-reply-all)").click()},"div.detailed-status__action-bar")}async function B(){async function e(e){$(e).is("div.detailed-status")&&(e=$(e).closest("div.focusable"));var t,n,a,o,r,s,i,c,l=function(t){var e,a,[i,n,o]=[!1,!1,!1];return $(t).find("span.display-name__account").length&&(n=$(t).find("span.display-name__account").first().text().trim()),$(t).is(".detailed-status__wrapper")?i=(a=window.location.href.split("?")[0].split("/")).pop()||a.pop():$(t).find("a.status__relative-time").attr("href")?!(a=$(t).find("a.status__relative-time").attr("href").split("?")[0]).startsWith("http")||(e=new URL(a),location.hostname==e.hostname)?i=(a=a.split("/")).pop()||a.pop():(i=a,o=!0):$(t).find("a.detailed-status__datetime").attr("href")?i=(a=$(t).find("a.detailed-status__datetime").attr("href").split("?")[0].split("/")).pop()||a.pop():$(t).attr("data-id")?i=$(t).attr("data-id").split("-").slice(-1)[0]:$(t).closest("article[data-id], div[data-id]").length?i=$(t).closest("article[data-id], div[data-id]")[0].attr("data-id").split("-").slice(-1)[0]:$(t).find("a.modal-button").length&&(i=(a=$(t).find("a.modal-button").attr("href").split("?")[0].split("/")).pop()||a.pop()),[i,n,o]}($(e));async function d(t,e){i=e,a=!1,$(i.currentTarget).children("i.fa-retweet").length?a=$(i.currentTarget).children("i.fa-retweet").hasClass("fediactive")?"unboost":"boost":$(i.currentTarget).children("i.fa-star").length?a=$(i.currentTarget).hasClass("fediactive")?"unfavourite":"favourite":$(i.currentTarget).children("i.fa-bookmark").length?a=$(i.currentTarget).hasClass("fediactive")?"unbookmark":"bookmark":$(i.currentTarget).attr("href")&&(~$(i.currentTarget).attr("href").indexOf("type=reblog")?a=$(i.currentTarget).hasClass("fediactive")?"unboost":"boost":~$(i.currentTarget).attr("href").indexOf("type=favourite")&&(a=$(i.currentTarget).hasClass("fediactive")?"unfavourite":"favourite"));var a,i=a;return i?await U(t,i)?("boost"==i||"unboost"==i?(R($(e.currentTarget).find("i"),[["color","!remove","rgb(140, 141, 255)"],["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive"),n&&(v[n][3]=!v[n][3])):"favourite"==i||"unfavourite"==i?(R($(e.currentTarget),[["color","!remove","rgb(202, 143, 4)"]],"fediactive"),n&&(v[n][4]=!v[n][4])):(R($(e.currentTarget),[["color","!remove","rgb(255, 80, 80)"]],"fediactive"),n&&(v[n][5]=!v[n][5])),!0):(g("Could not execute action on home instance."),!1):(g("Could not determine action."),!1)}function f(t){$(e).find(".feditriggered").remove(),t[1]?($(r).removeClass("disabled").removeAttr("disabled"),t[4]&&!$(a).hasClass("fediactive")&&R($(a),[["color","!remove","rgb(202, 143, 4)"]],"fediactive"),t[3]&&!$(o).find("i.fediactive").length&&R($(o).find("i"),[["color","!remove","rgb(140, 141, 255)"],["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive"),t[5]&&!$(r).hasClass("fediactive")&&R($(r),[["color","!remove","rgb(255, 80, 80)"]],"fediactive")):$("<span class='feditriggered' style='color: orange; padding-right: 10px; padding-left: 10px'>Not resolved</span>").insertAfter($(a))}function u(i){$(s).on("click",function(t){t.preventDefault(),t.stopImmediatePropagation(),y(i[6]+"?fedireply")}),$([a,o,r]).each(function(){var e,a=0;$(this).on("click",async function(t){t.preventDefault(),t.stopImmediatePropagation(),1==++a?e=setTimeout(async function(){await d(i[2],t)||g("Action failed."),a=0},350):(clearTimeout(e),await d(i[2],t)?y(i[6]):g("Action failed."),a=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})})}l?(n=j(l[0]),a=$(e).find("button:has(i.fa-star), a.icon-button:has(i.fa-star)").first(),o=$(e).find("button:has(i.fa-retweet), a.icon-button:has(i.fa-retweet)").first(),r=$(e).find("button:has(i.fa-bookmark)").first(),s=$(e).find("button:has(i.fa-reply), button:has(i.fa-reply-all), a.icon-button:has(i.fa-reply), a.icon-button:has(i.fa-reply-all)").first(),n?(f(c=v[n]),c[1]&&u(c)):(l[2]?t=l[0]:!(c=l[1].match(h)).groups.handledomain||~location.hostname.indexOf(c.groups.handledomain)?t=location.protocol+"//"+location.hostname+"/users/"+c.groups.handle+"/statuses/"+l[0]:(c=await F(location.protocol+"//"+location.hostname+"/"+l[1]+"/"+l[0]))?~c.indexOf("/users/")?t=c:h.test(c)&&(i=c.match(h))&&(t=c.split("@")[0]+"users/"+i.groups.handle+"/statuses/"+i.groups.tootid):(g("Resolve fallback #1"),t=location.protocol+"//"+location.hostname+"/"+l[1]+"/"+l[0]),t?(c=await E(t))?(i="https://"+m.fediact_homeinstance+"/@"+c[0]+"/"+c[1],D(c=[l[0],...c,i,!0]),u(c),f(c)):(g("Failed to resolve: "+t),D([l[0],!1]),f([l[0],!1])):(g("Could not identify a post URI for home resolving."),console.log(l),D([l[0],!1]),f([l[0],!1])))):g("Could not get toot data.")}$(document).DOMNodeAppear(async function(t){e($(t.target))},"div.status, div.detailed-status")}async function L(){var e,a="follow";var t=i.join(",");$(document).DOMNodeAppear(async function(t){!async function(i){async function n(t){if("follow"==a){if(await T(t))return $(i).text("Unfollow"),a="unfollow",!0}else if(await O(t))return $(i).text("Follow"),a="follow",!0}if($(i).closest("div.account-card").length)e=$(i).closest("div.account-card").find("div.display-name > span").text().trim();else for(const t of c)if($(t).length){e=$(t).text().trim();break}var o,r,s;e&&((o=await q(e))?(m.fediact_showfollows&&(await M([o[0]]))[0]&&($(i).text("Unfollow"),a="unfollow"),r=0,$(i).on("click",async function(t){var e,a;t.preventDefault(),t.stopImmediatePropagation(),1==++r?s=setTimeout(async function(){n(o[0]),r=0},350):(clearTimeout(s),await n(o[0])?(e=$(i).text(),a="https://"+m.fediact_homeinstance+"/@"+o[1],$(i).text("Redirecting..."),setTimeout(function(){y(a),$(i).text(e)},1e3)):g("Action failed."),r=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})):g("Could not resolve user home ID."))}($(t.target))},t)}function I(t){var e,a=[];for(e of t.split(/\r?\n/))(e=e.trim()).length&&(n.test(e)?a.push(e):g("Removed invalid domain "+e+" from blacklist/whitelist."));return[...new Set(a)]}function Q(){if(null==m.fediact_homeinstance||!m.fediact_homeinstance)return g("Mastodon home instance is not set."),!1;if(!m.fediact_token)return g("No API token available. Are you logged in to your home instance? If yes, wait for 1-2 minutes and reload page."),!1;if(m.tokenheader={Authorization:"Bearer "+m.fediact_token},!n.test(m.fediact_homeinstance))return g("Instance setting is not a valid domain name."),!1;if("whitelist"==m.fediact_mode){if(m.fediact_whitelist=I(m.fediact_whitelist),m.fediact_whitelist.length<1)return g("Whitelist is empty or invalid."),!1}else m.fediact_blacklist=I(m.fediact_blacklist);return!0}async function W(){if(location.hostname!=m.fediact_homeinstance||(p=b("fedireply"))){if("whitelist"==m.fediact_mode){if($.inArray(location.hostname,m.fediact_whitelist)<0)return g("Current site is not in whitelist."),!1}else if(-1<$.inArray(location.hostname,m.fediact_blacklist))return g("Current site is in blacklist."),!1;var t=await w("GET",location.protocol+"//"+location.hostname+o,null);if(t)if(JSON.parse(t).uri)return!0;g("Does not look like a Mastodon instance.")}else g("Current site is your home instance.");return!1}async function H(){chrome.runtime.onMessage.addListener(function(t,e,a){t.urlchanged&&(v=[]),t.updatedfedisettings&&location.reload()});try{return await chrome.runtime.sendMessage({running:!0}),!0}catch(t){g(t)}return!1}async function X(){try{m=await(browser||chrome).storage.local.get(t)}catch(t){return g(t),!1}m?Q()&&(await W()?p?G():H()?(L(),B()):g("Failed to initialize background script."):g("Will not process this site.")):g("Could not load settings.")}X();