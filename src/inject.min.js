const i=["div.account__header button.logo-button","div.public-account-header a.logo-button","div.account-card a.logo-button","div.directory-card a.icon-button","div.detailed-status a.logo-button","button.remote-button","div.account__header button.button--follow"],c=["div.account__header__tabs__name small","div.public-account-header__tabs__name small","div.detailed-status span.display-name__account","div.display-name > span","a.user-screen-name","div.profile-info-panel small"],a=/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/,I=/^(?<domain>https?:\/\/(?:\.?[a-z0-9-]+)+(?:\.[a-z]+){1})?\/?@(?<handle>\w+)(?:@(?<handledomain>(?:[\w-]+\.)+?\w+))?(?:\/(?<tootid>\d+))?\/?$/,M=/^(?<domain>https?:\/\/(?:\.?[a-z0-9-]+)+(?:\.[a-z]+){1})(?:\/users\/)(?<handle>\w+)(?:(?:\/statuses\/)(?<tootid>\d+))?\/?$/,e=!0,n="[FediAct]",o="/api/v1/instance",d="/api/v1/statuses",r="/api/v2/search",l="/api/v1/accounts",u="/api/v1/domain_blocks",f="/api/v1/polls",s=500,h=200,p=`
<div style="position: fixed; z-index: 99999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgb(0,0,0); background-color: rgba(0,0,0,0.4); margin: 0; padding: 0;" class="fedimodal">
	<div style="background-color: #494949; border: 1px solid #888; width: 50%; max-width: 300px; left: 50%; top: 50%; transform: translate(-50%, -50%); position: absolute; margin: 0; padding: 0;" class="fedimodal-content">
		<ul style="width: 100%; margin: 0; padding: 0;">
		</ul>
	</div>
</div>`;var browser,chrome,m,g,z={};const t={fediact_homeinstance:null,fediact_alert:!1,fediact_mode:"blacklist",fediact_whitelist:null,fediact_blacklist:null,fediact_target:"_self",fediact_autoaction:!0,fediact_token:null,fediact_showfollows:!0,fediact_redirects:!0,fediact_enabledelay:!0,fediact_hidemuted:!1,fediact_runifloggedin:!1,fediact_showtoot:!0,fediact_mutesblocks:[],fediact_domainblocks:[]};var[q,v,b]=[[],[],[]];function E(t){e&&console.log(n+" "+t)}function _(){return new Promise(function(e){var t;$(document).find("script#initial-state").length?(t=$(document).find("script#initial-state").first(),JSON.parse($(t).text()).meta.access_token&&e(!0)):$(document).DOMNodeAppear(function(t){t=$(t.target);JSON.parse($(t).text()).meta.access_token&&e(!0)},"script#initial-state"),e(!1)})}!function(a){a.fn.DOMNodeAppear=function(e,i){if(!i)return!1;a(document).on("animationstart webkitAnimationStart oanimationstart MSAnimationStart",function(t){"nodeInserted"==t.originalEvent.animationName&&a(t.target).is(i)&&"function"==typeof e&&e(t)})},jQuery.fn.onAppear=jQuery.fn.DOMNodeAppear}(jQuery);var w=function(t){for(var e,i=window.location.search.substring(1).split("&"),a=0;a<i.length;a++)if((e=i[a].split("="))[0]===t)return void 0===e[1]||decodeURIComponent(e[1]);return!1};async function k(a,n,o,r){var t,e;return~n.indexOf(z.fediact_homeinstance)&&z.fediact_enabledelay&&(t=Date.now(),(e=t-m)<s&&await new Promise(t=>{setTimeout(function(){t()},s-e)}),m=t),new Promise(function(t){let e=new XMLHttpRequest;if(e.open(a,n),e.timeout=3e3,o)for(var i in o)e.setRequestHeader(i,o[i]);e.onload=function(){200<=this.status&&this.status<300?t(e.responseText):t(!1)},e.onerror=function(){E("Request to "+n+" failed."),t(!1)},r?(e.setRequestHeader("Content-Type","application/json"),e.send(JSON.stringify(r))):e.send()})}function y(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function A(t,e,i){return t.replace(new RegExp(y(e),"g"),i)}function U(t){var e;z.fediact_redirects?z.fediact_alert&&!confirm("Redirecting to "+t)||(e=window.open(t,z.fediact_target),E("Redirected to "+t),e?e.focus():E("Could not open new window. Please allow popups for this website.")):E("Redirects disabled.")}async function J(t,e,i){var a,n,o,r="POST";switch(e){case"domainblock":a="https://"+z.fediact_homeinstance+u+"?domain="+t,n=function(t){if(t)return!0};break;case"domainunblock":a="https://"+z.fediact_homeinstance+u+"?domain="+t,n=function(t){if(t)return!0},r="DELETE";break;case"mute":a="https://"+z.fediact_homeinstance+l+"/"+t+"/mute",n=function(t){return t.muting};break;case"unmute":a="https://"+z.fediact_homeinstance+l+"/"+t+"/unmute",n=function(t){return!t.muting};break;case"block":a="https://"+z.fediact_homeinstance+l+"/"+t+"/block",n=function(t){return t.blocking};break;case"unblock":a="https://"+z.fediact_homeinstance+l+"/"+t+"/unblock",n=function(t){return!t.blocking};break;case"vote":a="https://"+z.fediact_homeinstance+f+"/"+t+"/votes",n=function(t){return t.voted},o=i;break;case"follow":a="https://"+z.fediact_homeinstance+l+"/"+t+"/follow",n=function(t){return t.following||t.requested};break;case"boost":a="https://"+z.fediact_homeinstance+d+"/"+t+"/reblog",n=function(t){return t.reblogged};break;case"favourite":a="https://"+z.fediact_homeinstance+d+"/"+t+"/favourite",n=function(t){return t.favourited};break;case"bookmark":a="https://"+z.fediact_homeinstance+d+"/"+t+"/bookmark",n=function(t){return t.bookmarked};break;case"unfollow":a="https://"+z.fediact_homeinstance+l+"/"+t+"/unfollow",n=function(t){return!t.following&&!t.requested};break;case"unboost":a="https://"+z.fediact_homeinstance+d+"/"+t+"/unreblog",n=function(t){return!t.reblogged};break;case"unfavourite":a="https://"+z.fediact_homeinstance+d+"/"+t+"/unfavourite",n=function(t){return!t.favourited};break;case"unbookmark":a="https://"+z.fediact_homeinstance+d+"/"+t+"/unbookmark",n=function(t){return!t.bookmarked};break;default:E("No valid action specified.")}if(a){var s=await k(r,a,z.tokenheader,o);if(s&&n(JSON.parse(s)))return!0}E(e+" action failed.")}async function C(t){var e="https://"+z.fediact_homeinstance+l+"/relationships?";for(const o of t)e+="id[]="+o.toString()+"&";var i=await k("GET",e,z.tokenheader,null),a=Array(t.length).fill(!1);if(i)for(var i=JSON.parse(i),n=0;n<t.length;n++)for(account of i)account.id==t[n]&&(account.following||account.requested)&&(a[n]=!0);return a}function j(t){if((t=t.startsWith("@")?t.slice(1):t).split("@").length-1==0&&(t=t+"@"+z.fediact_exturi),z.fediact_mutesblocks.includes(t)||z.fediact_domainblocks.includes(t.split("@")[1]))return!0}async function O(t){t=await k("GET","https://"+z.fediact_homeinstance+l+"/search?q="+t+"&resolve=true&limit=1&exclude_unreviewed=false",z.tokenheader,null);return!(!t||!(t=JSON.parse(t))[0].id)&&[t[0].id,t[0].acct]}async function F(t){var t=await k("GET","https://"+z.fediact_homeinstance+r+"/?q="+t+"&resolve=true&limit=1&exclude_unreviewed=false",z.tokenheader,null);return t&&!(t=JSON.parse(t)).accounts.length&&t.statuses.length?(t=t.statuses[0]).poll?[[t.account.acct,t.id,t.reblogged,t.favourited,t.bookmarked,t.account.id],[t.poll.id,t.poll.voted]]:[[t.account.acct,t.id,t.reblogged,t.favourited,t.bookmarked,t.account.id],[!1,!1]]:[!1,!1]}function G(t){return!!t&&new Promise(async function(e){try{await chrome.runtime.sendMessage({url:t},function(t){e(t||!1)})}catch(t){E(t),E("Reloading page, extension likely got updated or reloaded."),location.reload()}})}function W(t,e,i){var a,n,o=$(t).toggleClass(i).hasClass(i);for(a of e)o?$(t).css(a[0],a[2]):"!remove"==a[1]?(n=A($(t).attr("style"),a[0]+": "+a[2]+";",""),$(t).attr("style",n)):$(t).css(a[0],a[1])}function H(t){for(var e=0;e<q.length;e++)if(q[e][0]==t)return e;return!1}function L(t){q.push(t);t=q.length-h;return(q=0<t?q.splice(0,t):q).length-1}function Q(t){var i=$(p),e=$(i).find("ul");for(const n of t){var a=n[0].charAt(0).toUpperCase()+n[0].slice(1),a="<li style='cursor: pointer; width: 100%; padding: 5px 10px; box-sizing: border-box;'><a style='font-size: 16px; cursor: pointer; text-decoration: none; color: white;' fediaction='"+n[0]+"' fediid='"+n[1]+"'>"+a+"</a></li>";$(e).append($(a))}$("body").append($(i)),$("body").on("click",function(t){var e;!$(t.target).is(".fedimodal li, .fedimodal li a")||($(t.target).is(".fedimodal li")&&(t.target=$(t.target).find("a")),e=$(t.target).attr("fediaction"),J($(t.target).attr("fediid"),e,null))?($(i).remove(),$("body").off()):alert("Failed to "+e)})}async function N(){$(document).DOMNodeAppear(function(t){$(t.target).find("button:has(i.fa-reply), button:has(i.fa-reply-all)").click()},"div.detailed-status__action-bar")}async function R(){function P(t){var e;return!t.startsWith("http")||(e=new URL(t),location.hostname==e.hostname)?[!1,(t=t.split("/")).pop()||t.pop()]:[!0,t]}async function e(e){$(e).is("div.detailed-status")&&$(e).closest("div.focusable").length&&(e=$(e).closest("div.focusable"));var t=function(t){if($(t).find("span.display-name__account").length)return $(t).find("span.display-name__account").first().text().trim()}($(e));if(!function(t,e){if(z.fediact_hidemuted){var i,a,n=[],o=($(t).siblings(".status__prepend").length&&(i=$(t).siblings(".status__prepend").first(),$(i).find("a").attr("href"))&&n.push($(i).find("a").attr("href").split("?")[0]),$(t).find("span.h-card").each(function(){n.push($(this).find("a").attr("href").split("?")[0])}),[]);for(a of n){var r,s=a.split("/"),s=(s=s.pop()||s.pop()).slice(1);a.startsWith("http")&&(r=new URL(a)).hostname!=z.fediact_exturi&&r.hostname!=location.hostname?o.push(s+"@"+r.hostname):o.push(s+"@"+z.fediact_exturi)}return o.some(t=>z.fediact_mutesblocks.includes(t))||j(e)||o.some(t=>z.fediact_domainblocks.includes(t.split("@")[1]))?($(t).hide(),i&&$(i).hide(),1):void 0}}(e,t)){var i=function(t){if($(t).is(".detailed-status__wrapper"))return(e=window.location.href.split("?")[0].split("/")).pop()||e.pop();if($(t).attr("data-id"))return $(t).attr("data-id").split("-").slice(-1)[0];if($(t).closest("article[data-id], div[data-id]").length)return $(t).closest("article[data-id], div[data-id]").first().attr("data-id").split("-").slice(-1)[0];if($(t).find("a.icon-button:has(i.fa-star), a.detailed-status__link:has(i.fa-star)").length){var e=$(t).find("a.icon-button:has(i.fa-star), a.detailed-status__link:has(i.fa-star)").first();if($(e).attr("href")){t=$(e).attr("href");if(~t.indexOf("interact/"))return(e=t.split("?")[0].split("/")).pop()||e.pop()}}}($(e)),[a,n]=(a=$(e),$(a).find("a.status__relative-time").length?P($(a).find("a.status__relative-time").first().attr("href").split("?")[0]):$(a).find("a.detailed-status__datetime").length?P($(a).find("a.detailed-status__datetime").first().attr("href").split("?")[0]):$(a).find("a.modal-button").length?P($(a).find("a.modal-button").first().attr("href").split("?")[0]):[!1,void 0]),o=i||n;if(o){var r=[],s=H(o),c=$(e).find("button:has(i.fa-star)").first(),d=($(c).length||(c=$(e).find("a.icon-button:has(i.fa-star), a.detailed-status__link:has(i.fa-star)")),$(e).find("button:has(i.fa-retweet)").first()),l=($(d).length||(d=$(e).find("a.icon-button:has(i.fa-retweet), a.detailed-status__link:has(i.fa-retweet)")),$(e).find("button:has(i.fa-bookmark)").first()),u=$(e).find("button:has(i.fa-reply), button:has(i.fa-reply-all), a.icon-button:has(i.fa-reply), a.icon-button:has(i.fa-reply-all)").first(),f=$(e).find("div.poll button").first(),h=$(e).find("button:has(i.fa-ellipsis-h)").first();async function p(t,e,i){if(z.fediact_autoaction){for(var a={choices:[]},n=$(i.currentTarget).closest("div.poll"),o=$(n).find("li"),r=0;r<o.length;r++)$(o[r]).find("span.active").length&&a.choices.push(String(r));t=await J(t,"vote",a);return t&&($(i.currentTarget).hide(),$(n).find("ul").replaceWith("<p style='font-style: italic'><a style='font-weight:bold; color:orange' href='"+e+"' target='"+z.fediact_target+"'>View the results</a> on your home instance.<p>"),s)&&(q[s][10]=!0,q[s][11]=!0),t}}async function m(t,e){if(!z.fediact_autoaction)return E("Auto-action disabled."),!0;a=e,i=!1,$(a.currentTarget).children("i.fa-retweet").length?i=$(a.currentTarget).children("i.fa-retweet").hasClass("fediactive")?"unboost":"boost":$(a.currentTarget).children("i.fa-star").length?i=$(a.currentTarget).hasClass("fediactive")?"unfavourite":"favourite":$(a.currentTarget).children("i.fa-bookmark").length?i=$(a.currentTarget).hasClass("fediactive")?"unbookmark":"bookmark":$(a.currentTarget).attr("href")&&(~$(a.currentTarget).attr("href").indexOf("type=reblog")?i=$(a.currentTarget).hasClass("fediactive")?"unboost":"boost":~$(a.currentTarget).attr("href").indexOf("type=favourite")&&(i=$(a.currentTarget).hasClass("fediactive")?"unfavourite":"favourite"));var i,a=i;if(a){if(await J(t,a,null))return s&&(q[s][11]=!0),"boost"==a||"unboost"==a?(W($(e.currentTarget),[["color","!remove","rgb(140, 141, 255)"]],"fediactive"),W($(e.currentTarget).find("i"),[["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive"),s&&(q[s][3]=!q[s][3])):"favourite"==a||"unfavourite"==a?(W($(e.currentTarget),[["color","!remove","rgb(202, 143, 4)"]],"fediactive"),W($(e.currentTarget).find("i"),[["animation","spring-rotate-out 1s linear","spring-rotate-in 1s linear"]],"fediactive"),s&&(q[s][4]=!q[s][4])):(W($(e.currentTarget),[["color","!remove","rgb(255, 80, 80)"]],"fediactive"),s&&(q[s][5]=!q[s][5])),!0;E("Could not execute action on home instance.")}else E("Could not determine action.")}function g(t){$(e).find(".feditriggered").remove(),t[1]?($(l).removeClass("disabled").removeAttr("disabled"),$(h).removeClass("disabled").removeAttr("disabled"),$(f).removeAttr("disabled"),(z.fediact_showtoot||t[11])&&(t[4]&&!$(c).hasClass("fediactive")&&(W($(c),[["color","!remove","rgb(202, 143, 4)"]],"fediactive"),W($(c).find("i"),[["animation","spring-rotate-out 1s linear","spring-rotate-in 1s linear"]],"fediactive")),t[3]&&!$(d).find("i.fediactive").length&&(W($(d),[["color","!remove","rgb(140, 141, 255)"]],"fediactive"),W($(d).find("i"),[["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive")),t[5]&&!$(l).hasClass("fediactive")&&W($(l),[["color","!remove","rgb(255, 80, 80)"]],"fediactive"),t[10])&&($(f).hide(),$(f).closest("div.poll").find("ul").replaceWith("<p style='font-style: italic'><a style='font-weight:bold; color:orange' href='"+t[7]+"' target='"+z.fediact_target+"'>View the results</a> on your home instance.<p>"))):$("<span class='feditriggered' style='color: orange; padding-right: 10px; padding-left: 10px'>Unresolved</span>").insertAfter($(c))}function v(n){$(u).on("click",function(t){t.preventDefault(),t.stopImmediatePropagation(),U(n[7]+"?fedireply")}),$(h).on("click",function(t){t.preventDefault(),t.stopImmediatePropagation();t=n[1].split("@"),t=t.pop()||t.pop();console.log(t),Q([["mute",n[6]],["unmute",n[6]],["block",n[6]],["unblock",n[6]],["domainblock",t],["domainunblock",t]])}),$([c,d,l,f]).each(function(){$(f).length&&$(f).get(0).isEqualNode($(this).get(0))&&(e=!0);var e,i,a=0;$(this).on("click",async function(t){t.preventDefault(),t.stopImmediatePropagation(),1==++a?i=setTimeout(async function(){(e&&!n[10]?p(n[9],n[7],t):await m(n[2],t))||E("Action failed."),a=0},350):(clearTimeout(i),(e?p(n[9],n[7],t):await m(n[2],t))?U(n[7]):E("Action failed."),a=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})})}if(s){var b=q[s];g(b),b[1]&&v(b)}else{if(a&&r.push(n),t){var _,w,k,y=t.match(I),[x,T]=[!1,!1],A=(!y.groups.handledomain||~location.hostname.indexOf(y.groups.handledomain)||(x=!0),[i]);a||A.push(n);for(_ of A=A.filter((t,e)=>void 0!==t&&A.indexOf(t)==e))x?T||((w=await G(location.protocol+"//"+location.hostname+"/"+t+"/"+_))&&(T=!0,r.push(w),M.test(w)?(k=w.match(M)).groups.handle&&k.groups.tootid&&k.groups.domain&&r.push(k.groups.domain+"/@"+k.groups.handle+"/"+k.groups.tootid):I.test(w)&&(k=w.match(I)).groups.handle&&k.groups.tootid&&k.groups.domain&&r.push(k.groups.domain+"/users/"+k.groups.handle+"/statuses/"+k.groups.tootid)),r.push(location.protocol+"//"+location.hostname+"/"+t+"/"+_)):(r.push(location.protocol+"//"+location.hostname+"/users/"+y.groups.handle+"/statuses/"+_),r.push(location.protocol+"//"+location.hostname+"/@"+y.groups.handle+"/"+_))}if(r.length){var C,O,N,R,D,S=!1;for(C of r=r.filter((t,e)=>r.indexOf(t)==e))S||([O,N]=await F(C),O&&(S=!0,R="https://"+z.fediact_homeinstance+"/@"+O[0]+"/"+O[1],D=[o,...O,R,!0,...N,!1]));S?(s=L(D),g(D),v(D)):(E("Failed to resolve: "+r),s=L([o,!1]),g([o,!1]))}else E("Could not identify a post URI for home resolving."),s=L([o,!1]),g([o,!1])}}else E("Could not get toot data.")}}$(document).DOMNodeAppear(async function(t){b.includes($(t.target).get(0))||(b.push($(t.target).get(0)),e($(t.target)))},"div.status, div.detailed-status"),$(document).find("div.status, div.detailed-status").each(function(){b.includes($(this).get(0))||(b.push($(this).get(0)),e($(this)))})}async function D(){async function e(a){var t,n,o,r,e="follow";async function s(t){return z.fediact_autoaction?(t=await J(t,e,null),"follow"==e&&t?($(a).text("Unfollow"),e="unfollow",!0):"unfollow"==e&&t?($(a).text("Follow"),e="follow",!0):void 0):(E("Auto-action disabled."),!0)}if($(a).closest("div.account-card").length)t=$(a).closest("div.account-card").find("div.display-name > span").text().trim();else for(const i of c)if($(i).length){(t=$(i).text().trim()).split("@").length-1==1&&(t=t+"@"+z.fediact_exturi);break}t&&!v.includes(t)&&((n=await O(t))?(v.push(t),z.fediact_showfollows&&(await C([n[0]]))[0]&&($(a).text("Unfollow"),e="unfollow"),o=0,$(a).on("click",async function(t){var e,i;t.preventDefault(),t.stopImmediatePropagation(),1==++o?r=setTimeout(async function(){s(n[0]),o=0},350):(clearTimeout(r),await s(n[0])?(e=$(a).text(),i="https://"+z.fediact_homeinstance+"/@"+n[1],$(a).text("Redirecting..."),setTimeout(function(){U(i),$(a).text(e)},1e3)):E("Action failed."),o=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})):E("Could not resolve user home ID."))}var t=i.join(",");$(document).DOMNodeAppear(async function(t){b.includes($(t.target).get(0))||(b.push($(t.target).get(0)),e($(t.target)))},t),$(document).find(t).each(function(){b.includes($(this).get(0))||(b.push($(this).get(0)),e($(this)))})}function x(t){var e,i=[];for(e of t.split(/\r?\n/))(e=e.trim()).length&&(a.test(e)?i.push(e):E("Removed invalid domain "+e+" from blacklist/whitelist."));return[...new Set(i)]}function S(){if(null==z.fediact_homeinstance||!z.fediact_homeinstance)return E("Mastodon home instance is not set."),!1;if(!z.fediact_token)return E("No API token available. Are you logged in to your home instance? If yes, wait for 1-2 minutes and reload page."),!1;if(z.tokenheader={Authorization:"Bearer "+z.fediact_token},!a.test(z.fediact_homeinstance))return E("Instance setting is not a valid domain name."),!1;if("whitelist"==z.fediact_mode){if(z.fediact_whitelist=x(z.fediact_whitelist),z.fediact_whitelist.length<1)return E("Whitelist is empty or invalid."),!1}else z.fediact_blacklist=x(z.fediact_blacklist);return!0}async function P(){if(location.hostname==z.fediact_homeinstance&&!(g=w("fedireply")))return E("Current site is your home instance."),!1;if("whitelist"==z.fediact_mode){if($.inArray(location.hostname,z.fediact_whitelist)<0)return E("Current site is not in whitelist."),!1}else if(-1<$.inArray(location.hostname,z.fediact_blacklist))return E("Current site is in blacklist."),!1;var t=await k("GET",location.protocol+"//"+location.hostname+o,null,null);return!!t&&!(!(t=JSON.parse(t).uri)||(t.startsWith("http")?(t=new URL(t),z.fediact_exturi=t.hostname):z.fediact_exturi=t,V()?!z.fediact_runifloggedin&&await _()&&(E("Already logged in to this external instance."),1):(E("Could not start background process"),1)))}async function V(){chrome.runtime.onMessage.addListener(async function(t,e,i){t.urlchanged&&(q=[],v=[],b=[],await T()||location.reload()),t.updatedfedisettings&&location.reload()});try{return await chrome.runtime.sendMessage({running:!0}),!0}catch(t){E(t)}return!1}function T(){return new Promise(async function(e){try{z=await(browser||chrome).storage.local.get(t)}catch(t){E(t),e(!1)}z&&S()?e(!0):e(!1)})}async function B(){await T()?await P()?(g?N:(D(),R))():E("Will not process this site."):E("Could not load settings.")}B();