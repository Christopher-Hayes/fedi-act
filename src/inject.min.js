const e=["div.account__header button.logo-button","div.public-account-header a.logo-button","div.account-card a.logo-button","div.directory-card a.icon-button","div.detailed-status a.logo-button"],o=["div.account__header__tabs__name small","div.public-account-header__tabs__name small","div.detailed-status span.display-name__account","div.display-name > span"],a=/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/,i=/^(https?:\/\/(www\.)?.*\..*?\/)((@\w+(@([\w-]+\.)+?\w+)?)|explore|following|followers)\/?(\d+)?\/?$/,t=/^(https?:\/\/(www\.)?.*\..*?\/)((@\w+(@([\w-]+\.)+?\w+)?)|explore|public|public\/local)\/?(\d+)?\/?$/,n=/^(?:https?:\/\/(www\.)?.*\..*?\/)(@\w+(?:@([\w-]+\.)+?\w+)?)\/\d+\/?$/,s=/^[^@]*@(?<handle>\w+)(@(?<handledomain>([\w-]+\.)+?\w+))?\/?$/,l=!0,r="[FediFollow]",M=200,f="/api/v1/instance",c="/api/v1/statuses",d="/api/v2/search",u="/api/v1/accounts",w=500;var browser,chrome,h,p,m={};const v={fedifollow_homeinstance:null,fedifollow_alert:!1,fedifollow_mode:"blacklist",fedifollow_whitelist:null,fedifollow_blacklist:null,fedifollow_target:"_self",fedifollow_autoaction:!0,fedifollow_token:null,fedifollow_showfollows:!0,fedifollow_redirects:!0,fedifollow_enabledelay:!0};var b=window.location.href;function g(t){l&&console.log(r+" "+t)}!function(a){a.fn.DOMNodeAppear=function(e,o){var t=a(this);if(!(o=o||"function"==typeof t.selector&&t.selector))return!1;a(document).on("animationstart webkitAnimationStart oanimationstart MSAnimationStart",function(t){"nodeInserted"==t.originalEvent.animationName&&a(t.target).is(o)&&"function"==typeof e&&e(t)})},jQuery.fn.onAppear=jQuery.fn.DOMNodeAppear}(jQuery);var _=function(t){for(var e,o=window.location.search.substring(1).split("&"),a=0;a<o.length;a++)if((e=o[a].split("="))[0]===t)return void 0===e[1]||decodeURIComponent(e[1]);return!1};async function y(i,n,l){var t,e;return~n.indexOf(m.fedifollow_homeinstance)&&m.fedifollow_enabledelay&&(t=Date.now(),(e=t-h)<w&&await new Promise(t=>{setTimeout(function(){t()},w-e)}),h=t),new Promise(function(t,e){let o=new XMLHttpRequest;if(o.open(i,n),o.timeout=3e3,l)for(var a in l)o.setRequestHeader(a,l[a]);o.onload=function(){200<=this.status&&this.status<300?t(o.responseText):t(!1)},o.onerror=function(){e({status:this.status,statusText:o.statusText})},o.send()})}function k(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function T(t,e,o){return t.replace(new RegExp(k(e),"g"),o)}function O(t){var e;m.fedifollow_redirects?(m.fedifollow_alert&&alert("Redirecting..."),e=window.open(t,m.fedifollow_target),g("Redirected to "+t),e?e.focus():g("Could not open new window. Please allow popups for this website.")):g("Redirects disabled.")}async function A(t){if(m.fedifollow_autoaction){t=await y("POST","https://"+m.fedifollow_homeinstance+u+"/"+t+"/follow",m.tokenheader);if(t)return!(!(t=JSON.parse(t)).following&&!t.requested&&(g("Follow failed."),1))}else g("Auto-action disabled.")}async function x(t){if(m.fedifollow_autoaction){t=await y("POST","https://"+m.fedifollow_homeinstance+u+"/"+t+"/unfollow",m.tokenheader);if(t)return!(t=JSON.parse(t)).following&&!t.requested||(g("Unfollow failed."),!1)}else g("Auto-action disabled.")}async function S(t){if(m.fedifollow_autoaction){t=await y("POST","https://"+m.fedifollow_homeinstance+c+"/"+t+"/reblog",m.tokenheader);if(t)return!!JSON.parse(t).reblogged||(g("Boost failed."),!1)}else g("Auto-action disabled.")}async function N(t){if(m.fedifollow_autoaction){t=await y("POST","https://"+m.fedifollow_homeinstance+c+"/"+t+"/unreblog",m.tokenheader);if(t)return!JSON.parse(t).reblogged||(g("Unboost failed."),!1)}else g("Auto-action disabled.")}async function R(t){if(m.fedifollow_autoaction){t=await y("POST","https://"+m.fedifollow_homeinstance+c+"/"+t+"/favourite",m.tokenheader);if(t)return!!JSON.parse(t).favourited||(g("Favourite failed."),!1)}else g("Auto-action disabled.")}async function U(t){if(m.fedifollow_autoaction){t=await y("POST","https://"+m.fedifollow_homeinstance+c+"/"+t+"/unfavourite",m.tokenheader);if(t)return!JSON.parse(t).favourited||(g("Unfavourite failed."),!1)}else g("Auto-action disabled.")}async function E(t){if(m.fedifollow_autoaction){t=await y("POST","https://"+m.fedifollow_homeinstance+c+"/"+t+"/bookmark",m.tokenheader);if(t)return!!JSON.parse(t).bookmarked||(g("Bookmark failed."),!1)}else g("Auto-action disabled.")}async function F(t){if(m.fedifollow_autoaction){t=await y("POST","https://"+m.fedifollow_homeinstance+c+"/"+t+"/unbookmark",m.tokenheader);if(t)return!JSON.parse(t).bookmarked||(g("Unbookmark failed."),!1)}else g("Auto-action disabled.")}async function q(t){var e="https://"+m.fedifollow_homeinstance+u+"/relationships?";for(const n of t)e+="id[]="+n.toString()+"&";var o=await y("GET",e,m.tokenheader),a=Array(t.length).fill(!1);if(o)for(var o=JSON.parse(o),i=0;i<t.length;i++)for(account of o)account.id==t[i]&&account.following&&(a[i]=!0);return a}async function j(t,e){var o;switch(e){case"boost":o=await S(t);break;case"favourite":o=await R(t);break;case"bookmark":o=await E(t);break;case"unboost":o=await N(t);break;case"unfavourite":o=await U(t);break;case"unbookmark":o=await F(t);break;default:g("No valid action specified.")}return o}async function W(t){t=await y("GET","https://"+m.fedifollow_homeinstance+u+"/search?q="+t+"&resolve=true&limit=1",m.tokenheader);return!(!t||!(t=JSON.parse(t))[0].id)&&[t[0].id,t[0].acct]}async function z(t){var t=await y("GET","https://"+m.fedifollow_homeinstance+d+"/?q="+t+"&resolve=true&limit=1",m.tokenheader);return t?!(t=JSON.parse(t)).accounts.length&&t.statuses.length?[(t=t.statuses[0]).account.acct,t.id,t.reblogged,t.favourited,t.bookmarked]:(g("No toot result found."),!1):(g("API call failed..."),!1)}function G(t){return!!t&&new Promise(e=>{chrome.runtime.sendMessage({url:t},function(t){e(t||!1)})})}function C(t,e,o){var a,i,n=$(t).toggleClass(o).hasClass(o);for(a of e)n?$(t).css(a[0],a[2]):"!remove"==a[1]?(i=T($(t).attr("style"),a[0]+": "+a[2]+";",""),$(t).attr("style",i)):$(t).css(a[0],a[1])}function B(t,e,o,a){return o=o&&o.join(","),new MutationObserver(function(t){t.forEach(function(t){var e=t.addedNodes;null!==e&&$(e).each(function(){(!o||$(this).is(o))&&a(this,t)})})}).observe($(t)[0],e)}function H(t){for(const e of t)if($(e).length)return $(e).text().trim();return!1}async function L(){$(document).DOMNodeAppear(function(t){$(t.target).find("button:has(i.fa-reply), button:has(i.fa-reply-all)").click()},"div.detailed-status__action-bar")}async function P(){async function r(t,e){var o=function(t){var e=!1;$(t.currentTarget).children("i.fa-retweet").length?e=$(t.currentTarget).children("i.fa-retweet").hasClass("fediactive")?"unboost":"boost":$(t.currentTarget).children("i.fa-star").length?e=$(t.currentTarget).hasClass("fediactive")?"unfavourite":"favourite":$(t.currentTarget).children("i.fa-bookmark").length?e=$(t.currentTarget).hasClass("fediactive")?"unbookmark":"bookmark":$(t.currentTarget).attr("href")&&(~$(t.currentTarget).attr("href").indexOf("type=reblog")?e=$(t.currentTarget).hasClass("fediactive")?"unboost":"boost":~$(t.currentTarget).attr("href").indexOf("type=favourite")&&(e=$(t.currentTarget).hasClass("fediactive")?"unfavourite":"favourite"));return e}(e);return o?await j(t,o)?("boost"==o||"unboost"==o?C($(e.currentTarget).find("i"),[["color","!remove","rgb(140, 141, 255)"],["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive"):C($(e.currentTarget),"favourite"==o||"unfavourite"==o?[["color","!remove","rgb(202, 143, 4)"]]:[["color","!remove","rgb(255, 80, 80)"]],"fediactive"),!0):(g("Could not execute action on home instance."),!1):(g("Could not determine action."),!1)}async function o(t){var a,e,o,i,n=location.protocol+"//"+location.hostname+"/",l=function(t){var e,[o,a]=[!1,!1];return $(t).find("span.display-name__account").length&&(a=$(t).find("span.display-name__account").first().text().trim()),$(t).is(".detailed-status__wrapper")?o=b.split("?")[0].split("/")[4]:$(t).find("a.status__relative-time").attr("href")?o=(e=$(t).find("a.status__relative-time").attr("href").split("?")[0]).startsWith("http")?e.split("/")[4]:e.split("/")[2]:$(t).find("a.detailed-status__datetime").attr("href")?o=(e=$(t).find("a.detailed-status__datetime").attr("href").split("?")[0]).startsWith("http")?e.split("/")[4]:e.split("/")[2]:$(t).attr("data-id")?o=$(t).attr("data-id").split("-").slice(-1)[0]:$(t).closest("article[data-id], div[data-id]").length?o=$(t).closest("article[data-id], div[data-id]")[0].attr("data-id").split("-").slice(-1)[0]:$(t).find("a.modal-button").length&&(o=(e=$(t).find("a.modal-button").attr("href").split("?")[0]).startsWith("http")?e.split("/")[4]:e.split("/")[2]),[o,a]}($(t));l?(console.log(l),(e=l[1].match(s)).groups.handledomain?~location.hostname.indexOf(e.groups.handledomain)?n+=(clearedHandle=l[1].split("@"+e.groups.handledomain)[0])+"/"+l[0]:n=await G(location.protocol+"//"+location.hostname+"/"+l[1]+"/"+l[0])||"https://"+e.groups.handledomain+"/@"+e.groups.handle+"/"+l[0]:n+=l[1]+"/"+l[0],n?(a=await z(n))?(e=$(t).find("button:has(i.fa-star), a.icon-button:has(i.fa-star)"),l=$(t).find("button:has(i.fa-retweet), a.icon-button:has(i.fa-retweet)"),o=$(t).find("button:has(i.fa-bookmark)"),t=$(t).find("button:has(i.fa-reply), button:has(i.fa-reply-all), a.icon-button:has(i.fa-reply), a.icon-button:has(i.fa-reply-all)"),$(o).removeClass("disabled").removeAttr("disabled"),a[3]&&!$(e).hasClass("fediactive")&&C($(e),[["color","!remove","rgb(202, 143, 4)"]],"fediactive"),a[2]&&!$(l).find("i.fediactive").length&&C($(l).find("i"),[["color","!remove","rgb(140, 141, 255)"],["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive"),a[4]&&!$(o).hasClass("fediactive")&&C($(o),[["color","!remove","rgb(255, 80, 80)"]],"fediactive"),i="https://"+m.fedifollow_homeinstance+"/@"+a[0]+"/"+a[1],$(t).on("click",function(t){t.preventDefault(),t.stopImmediatePropagation(),O(i+"?fedireply")}),$([e,l,o]).each(function(){var e,o=0;$(this).on("click",async function(t){t.preventDefault(),t.stopImmediatePropagation(),1==++o?e=setTimeout(async function(){await r(a[1],t)||g("Action failed."),o=0},350):(clearTimeout(e),await r(a[1],t)?O(i):g("Action failed."),o=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})})):g("Failed to resolve: "+n):g("Could not identify a post URI for home resolving.")):g("Could not get toot data.")}t.test(b.split("?")[0])?n.test(b)?($(document).find("div.detailed-status__wrapper").each(function(){o($(this))}),$(document).DOMNodeAppear(async function(t){o($(t.target))},"div.status, div.detailed-status__wrapper")):($(document).ready(async function(){var a=$("body").html();await new Promise(e=>{var o=setInterval(function(){var t=$("body").html();t==a?(changing=!1,e(!0),clearInterval(o)):a=t},100)}),$(document).find("div.entry > div.status").each(function(){o($(this))})}),$(document).DOMNodeAppear(async function(t){var t=$(t.target),a=$("body").html();await new Promise(e=>{var o=setInterval(function(){var t=$("body").html();t==a?(changing=!1,e(!0),clearInterval(o)):a=t},100)}),t.find("div.status").each(async function(){document.body.contains($(this)[0])&&o($(this))}),B(t,{subtree:!0,childList:!0},["div.status"],function(t,e){o($(t))})},"article, div.entry > div.status")):g("There are no toots on this site")}async function I(){var t;i.test(b.split("?")[0])?(t=e.join(","),$(document).DOMNodeAppear(async function(t){!async function(i){var t,n,l,r,s="follow";if($(i).closest("div.account-card").length)t=$(i).closest("div.account-card").find("div.display-name > span").text().trim();else for(const e of o)if($(e).length){t=$(e).text().trim();break}t&&((n=await W(t))?(m.fedifollow_showfollows&&(await q([n[0]]))[0]&&($(i).text("Unfollow"),s="unfollow"),l=0,$(i).off(),$(i).unbind(),$(i).on("click",async function(t){var e,o,a;t.preventDefault(),t.stopImmediatePropagation(),1==++l?r=setTimeout(async function(){"follow"==s?await A(n[0])&&($(i).text("Unfollow"),s="unfollow"):await x(n[0])&&($(i).text("Follow"),s="follow"),l=0},350):(clearTimeout(r),"follow"==s?await A(n[0])&&($(i).text("Unfollow"),s="unfollow",e=!0):await x(n[0])&&($(i).text("Follow"),s="follow",e=!0),e?(o=$(i).text(),a="https://"+m.fedifollow_homeinstance+"/@"+n[1],$(i).text("Redirecting..."),setTimeout(function(){O(a),$(i).text(o)},1e3)):g("Action failed."),l=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})):g("Could not resolve user home ID."))}($(t.target))},t)):g("Not a profile URL.")}async function D(){setTimeout(function(){b!=window.location.href&&(b=window.location.href,I(),P()),D()},300)}function J(t){var e,o=[];for(e of t.split(/\r?\n/))e=e.trim(),a.test(e)?o.push(e):g("Removed invalid domain "+e+" from blacklist/whitelist.");return[...new Set(o)]}function Q(){if(null==m.fedifollow_homeinstance||!m.fedifollow_homeinstance)return g("Mastodon home instance is not set."),!1;if(!m.fedifollow_token)return g("No API token available. Are you logged in to your home instance? If yes, wait for 1-2 minutes and reload page."),!1;if(m.tokenheader={Authorization:"Bearer "+m.fedifollow_token},!a.test(m.fedifollow_homeinstance))return g("Instance setting is not a valid domain name."),!1;if($.inArray(m.fedifollow_mode,["blacklist","whitelist"])<0&&(m.fedifollow_mode="blacklist"),$.inArray(m.fedifollow_target,["_blank","_self"])<0&&(m.fedifollow_target="_blank"),"whitelist"==m.fedifollow_mode){if(m.fedifollow_whitelist=J(m.fedifollow_whitelist),m.fedifollow_whitelist.length<1)return g("Whitelist is empty or invalid."),!1}else m.fedifollow_blacklist=J(m.fedifollow_blacklist);return!0}async function X(){if(location.hostname!=m.fedifollow_homeinstance||(p=_("fedireply"))){if("whitelist"==m.fedifollow_mode){if($.inArray(location.hostname,m.fedifollow_whitelist)<0)return g("Current site is not in whitelist."),!1}else if(-1<$.inArray(location.hostname,m.fedifollow_blacklist))return g("Current site is in blacklist."),!1;var t=await y("GET",location.protocol+"//"+location.hostname+f,null);if(t)if(JSON.parse(t).uri)return!0;g("Does not look like a Mastodon instance.")}else g("Current site is your home instance.");return!1}async function K(){(m=await(browser||chrome).storage.local.get(v))?Q()&&(await X()?(p?L:(I(),P(),D))():g("Will not process this site.")):g("Could not load settings.")}K();