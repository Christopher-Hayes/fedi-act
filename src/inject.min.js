const a=["div.account__header button.logo-button","div.public-account-header a.logo-button","div.account-card a.logo-button","div.directory-card a.icon-button","div.directory__card a.icon-button","div.detailed-status a.logo-button","button.remote-button","div.account__header button.button--follow"],p=["div.account__header__tabs__name small","div.public-account-header__tabs__name small","div.detailed-status span.display-name__account","div.display-name > span","a.user-screen-name","div.profile-info-panel small"],i=/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/,M=/^(?<domain>https?:\/\/(?:\.?[a-z0-9-]+)+(?:\.[a-z]+){1})?\/?@(?<handle>\w+)(?:@(?<handledomain>(?:[\w-]+\.)+?\w+))?(?:\/(?<tootid>\d+))?\/?$/,F=/^(?<domain>https?:\/\/(?:\.?[a-z0-9-]+)+(?:\.[a-z]+){1})(?:\/users\/)(?<handle>\w+)(?:(?:\/statuses\/)(?<tootid>\d+))?\/?$/,e=!1,n="[FediAct]",o="/api/v1/instance",d="/api/v1/statuses",s="/api/v2/search",l="/api/v1/accounts",w="/api/v1/mutes",_="/api/v1/blocks",u="/api/v1/domain_blocks",f="/api/v1/polls",r=600,c=200,h='<div class="fediactmodal"><div class="fediactmodalinner"><ul class="fediactmodallist"></ul></div></div>',k=10;var browser,chrome,q={};const y={fediact_homeinstance:null,fediact_alert:!1,fediact_mode:"blacklist",fediact_whitelist:null,fediact_blacklist:null,fediact_target:"_self",fediact_autoaction:!0,fediact_token:null,fediact_redirects:!0,fediact_enabledelay:!0,fediact_hidemuted:!1,fediact_runifloggedin:!1,fediact_mutes:[],fediact_blocks:[],fediact_domainblocks:[]},z={fedireply:void 0,lasthomerequest:void 0,whitelist:void 0,blacklist:void 0,exturi:void 0,tokenheader:void 0,processed:[],processedFollow:[],isProcessing:[]};function L(t){e&&console.log(n+" "+t)}function W(t){let e=$(t).find("i").first();return e=e.length?e:$(t).find("svg").first()}function C(t){return"Reply"===$(t).attr("aria-label")}function x(t){return"Boost"===$(t).attr("aria-label")}function T(t){return"Favorite"===$(t).attr("aria-label")}function A(){return new Promise(function(e){var t;$(document).find("script#initial-state").length?(t=$(document).find("script#initial-state").first(),JSON.parse($(t).text()).meta.access_token&&e(!0)):$(document).DOMNodeAppear(function(t){t=$(t.target);JSON.parse($(t).text()).meta.access_token&&e(!0)},"script#initial-state"),e(!1)})}!function(i){i.fn.DOMNodeAppear=function(e,a){if(!a)return!1;i(document).on("animationstart webkitAnimationStart oanimationstart MSAnimationStart",function(t){"fa_nodeInserted"==t.originalEvent.animationName&&i(t.target).is(a)&&"function"==typeof e&&e(t)})},jQuery.fn.onAppear=jQuery.fn.DOMNodeAppear}(jQuery);var P=function(t){for(var e,a=window.location.search.substring(1).split("&"),i=0;i<a.length;i++)if((e=a[i].split("="))[0]===t)return void 0===e[1]||decodeURIComponent(e[1]);return!1};const O=(a,i)=>{let n=[];return async function(...t){for(;n.length>=i;)await Promise.race(n).catch(()=>{});const e=a.apply(this,t);return n.push(e),await e.catch(()=>{}),n=n.filter(t=>t!==e),e}};function D(t,i,n,o){return new Promise(async function(e){var a;~i.indexOf(q.fediact_homeinstance)&&q.fediact_enabledelay&&((a=Date.now()-z.lasthomerequest)<r&&await new Promise(t=>{setTimeout(function(){t()},r-a)}),z.lasthomerequest=Date.now());try{await chrome.runtime.sendMessage({requestdata:[t,i,n,o]},function(t){e(t||!1)})}catch(t){L(t),L("Reloading page, extension likely got updated or reloaded."),location.reload()}})}const m=O(D,k);function S(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function R(t,e,a){return t.replace(new RegExp(S(e),"g"),a)}function B(t){var e;q.fediact_redirects?("_self"==q.fediact_target&&(window.onpageshow=function(t){t.persisted&&window.location.reload()}),q.fediact_alert&&!confirm("Redirecting to "+t)||(e=window.open(t,q.fediact_target),L("Redirected to "+t),e?e.focus():L("Could not open new window. Please allow popups for this website."))):L("Redirects disabled.")}async function J(t,e,a){var i,n,o,s,r="POST";switch(e){case"copy":return navigator.clipboard.writeText(t),!0;case"domainblock":i="https://"+q.fediact_homeinstance+u+"?domain="+t,n=function(t){if(t)return!0},s=async function(){await v()};break;case"domainunblock":i="https://"+q.fediact_homeinstance+u+"?domain="+t,n=function(t){if(t)return!0},r="DELETE",s=async function(){await v()};break;case"mute":i="https://"+q.fediact_homeinstance+l+"/"+t+"/mute",n=function(t){return t.muting},s=async function(){await v()};break;case"unmute":i="https://"+q.fediact_homeinstance+l+"/"+t+"/unmute",n=function(t){return!t.muting},s=async function(){await v()};break;case"block":i="https://"+q.fediact_homeinstance+l+"/"+t+"/block",n=function(t){return t.blocking},s=async function(){await v()};break;case"unblock":i="https://"+q.fediact_homeinstance+l+"/"+t+"/unblock",n=function(t){return!t.blocking},s=async function(){await v()};break;case"vote":i="https://"+q.fediact_homeinstance+f+"/"+t+"/votes",n=function(t){return t.voted},o=a;break;case"follow":i="https://"+q.fediact_homeinstance+l+"/"+t+"/follow",n=function(t){return t.following||t.requested};break;case"boost":i="https://"+q.fediact_homeinstance+d+"/"+t+"/reblog",n=function(t){return t.reblogged};break;case"favourite":i="https://"+q.fediact_homeinstance+d+"/"+t+"/favourite",n=function(t){return t.favourited};break;case"bookmark":i="https://"+q.fediact_homeinstance+d+"/"+t+"/bookmark",n=function(t){return t.bookmarked};break;case"unfollow":i="https://"+q.fediact_homeinstance+l+"/"+t+"/unfollow",n=function(t){return!t.following&&!t.requested};break;case"unboost":i="https://"+q.fediact_homeinstance+d+"/"+t+"/unreblog",n=function(t){return!t.reblogged};break;case"unfavourite":i="https://"+q.fediact_homeinstance+d+"/"+t+"/unfavourite",n=function(t){return!t.favourited};break;case"unbookmark":i="https://"+q.fediact_homeinstance+d+"/"+t+"/unbookmark",n=function(t){return!t.bookmarked};break;default:return void L("No valid action specified.")}if(i){var c=await m(r,i,z.tokenheader,o);if(c&&n(JSON.parse(c)))return void 0!==s&&await s(),!0}L(e+" action failed.")}async function U(t){var e="https://"+q.fediact_homeinstance+l+"/relationships?";for(const o of t)e+="id[]="+o.toString()+"&";var a=await m("GET",e,z.tokenheader,null),i=Array(t.length).fill(!1);if(a)for(var a=JSON.parse(a),n=0;n<t.length;n++)for(account of a)account.id==t[n]&&(account.following||account.requested)&&(i[n]=!0);return i}function g(t){return t=(t=t.startsWith("@")?t.slice(1):t).split("@").length-1==0?t+"@"+z.exturi:t}function G(t){if(t=g(t),q.fediact_blocks.includes(t))return!0}function j(t){if(t=g(t),q.fediact_mutes.includes(t))return!0}function Q(t){if(t=g(t),q.fediact_domainblocks.includes(t.split("@")[1]))return!0}function V(t){if(j(t)||G(t)||Q(t))return!0}async function E(t){t="https://"+q.fediact_homeinstance+l+"/search?q="+t+"&resolve=true&limit=1&exclude_unreviewed=false",t=await m("GET",t,z.tokenheader,null);return!(!t||!(t=JSON.parse(t))[0].id)&&[t[0].id,t[0].acct]}async function Z(t){var t="https://"+q.fediact_homeinstance+s+"/?q="+t+"&resolve=true&limit=1&exclude_unreviewed=false",t=await m("GET",t,z.tokenheader,null);return t&&!(t=JSON.parse(t)).accounts.length&&t.statuses.length?(t=t.statuses[0]).poll?[[t.account.acct,t.id,t.reblogged,t.favourited,t.bookmarked,t.account.id],[t.poll.id,t.poll.voted]]:[[t.account.acct,t.id,t.reblogged,t.favourited,t.bookmarked,t.account.id],[!1,!1]]:[!1,!1]}function tt(t){return!!t&&new Promise(async function(e){try{await chrome.runtime.sendMessage({externaltoot:t},function(t){e(t||!1)})}catch(t){L(t),L("Reloading page, extension likely got updated or reloaded."),location.reload()}})}function X(t,e,a){var i,n,o=$(t).toggleClass(a).hasClass(a);for(i of e)o?$(t).css(i[0],i[2]):"!remove"==i[1]?(n=R($(t).attr("style"),i[0]+": "+i[2]+";",""),$(t).attr("style",n)):$(t).css(i[0],i[1])}function et(t){for(var e=0;e<z.processed.length;e++)if(z.processed[e][0]==t)return e;return!1}function H(t){z.processed.push(t);t=z.processed.length-c;return 0<t&&(z.processed=z.processed.splice(0,t)),z.processed.length-1}function v(){return new Promise(async function(e){try{await chrome.runtime.sendMessage({updatemutedblocked:!0},async function(t){t?await b()?e(!0):location.reload():e(!1)})}catch(t){L(t),L("Reloading page, extension likely got updated or reloaded."),location.reload()}})}function K(t){var i=$(h),e=$(i).find("ul");for(const n of t){var a="<li class='fediactmodalitem'><a class='fediactmodallink' fediactaction='"+n[0]+"' fediactdata='"+n[1]+"'><span>"+n[2]+"</span></a></li>";$(e).append($(a))}$("body").append($(i)),$("body").on("click",async function t(e){var a;e.originalEvent.isTrusted&&($(e.target).is(".fediactmodal li, .fediactmodal li *")?($(e.target).is(".fediactmodal li a")||($(e.target).find("a").length?e.target=$(e.target).find("a"):e.target=$(e.target).closest("a")),a=$(e.target).attr("fediactaction"),await J($(e.target).attr("fediactdata"),a,null)?($(e.target).addClass("activated"),$(e.target).append("<span>Done!</span>"),$(i).css("animation","fadeOut .2s .7s forwards"),$(i).find(".fediactmodalinner").css("animation","scaleInFade .2s .7s forwards reverse"),await new Promise(t=>{setTimeout(function(){t()},1e3)})):($(e.target).css("--confirmation","red"),$(e.target).addClass("activated"),$(e.target).append("<span>Failed</span>"),$(i).css("animation","fadeOut .2s .7s forwards"),$(i).find(".fediactmodalinner").css("animation","scaleInFade .2s .7s forwards reverse"),await new Promise(t=>{setTimeout(function(){t()},1e3)})),$(i).remove(),$("body").off("click",t)):$(e.target).is(".fediactmodalinner")?$.noop():($(i).remove(),$("body").off("click",t)))})}function Y(){$(".fediacticon").length||($("body").append("<div class='fediacticon'></div>"),$("body").append("<div class='fediactsettings_onsite'><div class='fediactsettings_onsite_inner'><a href='https://"+q.fediact_homeinstance+"' target='"+q.fediact_target+"'>Go home</a></div></div>"),$("body").on("click",function(t){try{t.originalEvent.isTrusted&&($(t.target).is("div.fediacticon")?($("div.fediacticon").hide(),$("div.fediactsettings_onsite")):($("div.fediactsettings_onsite").hide(),$("div.fediacticon"))).show()}catch{$.noop()}}))}async function I(){$(document).DOMNodeAppear(function(t){$(t.target).find("button:has(.icon-reply, .fa-reply), button:has(i.fa-reply-all)").click()},"div.detailed-status__action-bar")}async function N(){function N(t){var e;return!t.startsWith("http")||(e=new URL(t),location.hostname==e.hostname)?[!1,(t=t.split("/")).pop()||t.pop()]:[!0,t]}async function e(e){Y(),$(e).is("div.detailed-status")&&$(e).closest("div.focusable").length&&(a=!0,e=$(e).closest("div.focusable"));var a,t=function(t){if($(t).find("span.display-name__account").length)return $(t).find("span.display-name__account").first().text().trim()}($(e));if(!function(t,e){if(q.fediact_hidemuted){var a,i,n=[],o=($(t).siblings(".status__prepend").length&&(a=$(t).siblings(".status__prepend").first(),$(a).find("a").attr("href"))&&n.push($(a).find("a").attr("href").split("?")[0]),$(t).find("span.h-card").each(function(){n.push($(this).find("a").attr("href").split("?")[0])}),[]);for(i of n){var s,r=i.split("/"),r=(r=r.pop()||r.pop()).slice(1);i.startsWith("http")&&(s=new URL(i)).hostname!=z.exturi&&s.hostname!=location.hostname?o.push(r+"@"+s.hostname):o.push(r+"@"+z.exturi)}return o.some(t=>V(t))||V(e)?($(t).hide(),a&&$(a).hide(),1):void 0}}(e,t)){var i=function(t){if($(t).is(".detailed-status__wrapper"))return(e=window.location.href.split("?")[0].split("/")).pop()||e.pop();if($(t).attr("data-id"))return $(t).attr("data-id").split("-").slice(-1)[0];if($(t).closest("article[data-id], div[data-id]").length)return $(t).closest("article[data-id], div[data-id]").first().attr("data-id").split("-").slice(-1)[0];if($(t).find("a.icon-button:has(.fa-star, .icon-star), a.detailed-status__link:has(.fa-star, .icon-star)").length){var e=$(t).find("a.icon-button:has(.fa-star, .icon-star), a.detailed-status__link:has(.fa-star, .icon-star)").first();if($(e).attr("href")){t=$(e).attr("href");if(~t.indexOf("interact/"))return(e=t.split("?")[0].split("/")).pop()||e.pop()}}}($(e)),[n,o]=(n=$(e),$(n).find("a.status__relative-time").length?N($(n).find("a.status__relative-time").first().attr("href").split("?")[0]):$(n).find("a.detailed-status__datetime").length?N($(n).find("a.detailed-status__datetime").first().attr("href").split("?")[0]):$(n).find("a.modal-button").length?N($(n).find("a.modal-button").first().attr("href").split("?")[0]):[!1,void 0]),s=i||o;if(s){var r=[],c=!1,d=et(s),l=$(e).find("button.star-icon").first(),u=($(l).length||(l=$(e).find("a.icon-button:has(.fa-star, .icon-star), a.detailed-status__link:has(.fa-star, .icon-star)")),a?$("<div class='detailed-status__button fediactprocessingdetailed'><span class='fediactprocessing'></span></div>").insertAfter($(l).parent()):$("<span class='fediactprocessing'></span>").insertAfter($(l)),$(e).find("button:has(.icon-retweet, .fa-retweet)").first()),f=($(u).length||(u=$(e).find("a.icon-button:has(i.fa-retweet), a.detailed-status__link:has(i.fa-retweet)")),$(e).find("button:has(.icon-bookmark, .fa-bookmark)").first()),p=$(e).find("button:has(.icon-reply, .fa-reply), button:has(i.fa-reply-all), a.icon-button:has(i.fa-reply), a.icon-button:has(i.fa-reply-all)").first(),h=$(e).find('button[class*="show-more"]').first(),m=$(e).find("div.poll button").first(),g=($(h).length&&($(h).click(),$(e).find("div.poll").length&&(c=!0),$(h).click()),$(e).find("button:has(i.fa-ellipsis-h,i.fa-ellipsis-fw,i.fa-ellipsis-v)").first());async function v(t,e,a){if(q.fediact_autoaction){for(var i={choices:[]},n=$(a.currentTarget).closest("div.poll"),o=$(n).find("li"),s=0;s<o.length;s++)$(o[s]).find("span.active").length&&i.choices.push(String(s));t=await J(t,"vote",i);return t&&($(a.currentTarget).hide(),$(n).find("ul").replaceWith("<p class='fediactvoted'><a href='"+e+"' target='"+q.fediact_target+"'>View the results</a> on your home instance.<p>"),d)&&(z.processed[d][10]=!0,z.processed[d][11]=!0),t}}async function b(t,e){if(!q.fediact_autoaction)return L("Auto-action disabled."),!0;var a=function(t){let e=!1;var a=W(t=t.currentTarget);return a.hasClass("fa-retweet")||a.hasClass("icon-retweet")?e=a.hasClass("fediactive")?"unboost":"boost":a.hasClass("fa-star")||a.hasClass("icon-star")?e=$(t).hasClass("fediactive")?"unfavourite":"favourite":a.hasClass("fa-bookmark")||a.hasClass("icon-bookmark")?e=$(t).hasClass("fediactive")?"unbookmark":"bookmark":$(t).attr("href")&&(~$(t).attr("href").indexOf("type=reblog")?e=$(t).hasClass("fediactive")?"unboost":"boost":~$(t).attr("href").indexOf("type=favourite")&&(e=$(t).hasClass("fediactive")?"unfavourite":"favourite")),e}(e);if(a){if(await J(t,a,null))return d&&(console.log(d),console.log(z.processed[d]),console.log(z.processed),z.processed[d][11]=!0),"boost"==a||"unboost"==a?(X($(e.currentTarget),[["color","!remove","rgb(140, 141, 255)"]],"fediactive"),X(W(e.currentTarget),[["animation","spring-rotate-out 1s linear","spring-rotate-in 1s linear"]],"fediactive"),d&&(z.processed[d][3]=!z.processed[d][3])):"favourite"==a||"unfavourite"==a?(X($(e.currentTarget),[["color","!remove","rgb(202, 143, 4)"]],"fediactive"),X(W(e.currentTarget),[["animation","spring-rotate-out 1s linear","spring-rotate-in 1s linear"]],"fediactive"),d&&(z.processed[d][4]=!z.processed[d][4])):(X($(e.currentTarget),[["color","!remove","rgb(255, 80, 80)"]],"fediactive"),d&&(z.processed[d][5]=!z.processed[d][5])),!0;L("Could not execute action on home instance.")}else L("Could not determine action.")}function w(t){$(e).find(".fediactunresolveddetailed, .fediactunresolved").remove(),$(e).find(".fediactprocessingdetailed, .fediactprocessing").remove(),t[1]?($(f).removeClass("disabled").removeAttr("disabled"),$(g).removeClass("disabled").removeAttr("disabled"),t[13]&&($(h).click(),$(h).find("span").text("Show less"),m=$(e).find("div.poll button").first(),$(h).on("click",function(t){t.preventDefault(),t.stopImmediatePropagation();t=$(h).find("span");"Show less"==$(t).text()?$(t).text("Show more"):$(t).text("Show less"),X($(e).find("div.poll").first(),[["display","block","none"]],"fedihideshow"),X($(e).find("div.status__content__text").first(),[["display","block","none"]],"fedihideshow")}),$(h).click()),$(m).removeAttr("disabled"),t[4]&&!$(l).hasClass("fediactive")&&(X($(l),[["color","!remove","rgb(202, 143, 4)"]],"fediactive"),X(W(l),[["animation","spring-rotate-out 1s linear","spring-rotate-in 1s linear"]],"fediactive")),t[3]&&!$(u).find("i.fediactive").length&&(X($(u),[["color","!remove","rgb(140, 141, 255)"]],"fediactive"),X(W(u),[["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive")),t[5]&&!$(f).hasClass("fediactive")&&X($(f),[["color","!remove","rgb(255, 80, 80)"]],"fediactive"),t[10]&&($(m).hide(),$(m).closest("div.poll").find("ul").replaceWith("<p class='fediactvoted'><a href='"+t[7]+"' target='"+q.fediact_target+"'>View the results</a> on your home instance.<p>"))):a?$("<div class='detailed-status__button fediactunresolveddetailed'><span class='fediactunresolved'>X</span></div>").insertAfter($(l).parent()):$("<span class='fediactunresolved'>X</span>").insertAfter($(l))}function _(n){var t=n[1].split("@"),e=t.pop()||t.pop();$(p).on("click",function(t){t.preventDefault(),t.stopImmediatePropagation(),t.originalEvent.isTrusted&&B(n[7]+"?fedireply")}),$(g).on("click",function(t){t.preventDefault(),t.stopImmediatePropagation(),t.originalEvent.isTrusted&&(t=[],G(n[1])?t.push(["unblock",n[6],"Unblock user"]):t.push(["block",n[6],"Block user"]),j(n[1])?t.push(["unmute",n[6],"Unmute user"]):t.push(["mute",n[6],"Mute user"]),Q(n[1])?t.push(["domainunblock",e,"Unblock domain"]):t.push(["domainblock",e,"Block domain"]),t.push(["copy",n[12],"Copy URL"]),t.push(["copy",n[7],"Copy home URL"]),K(t))}),$([l,u,f,m]).each(function(){$(m).length&&$(m).get(0).isEqualNode($(this).get(0))&&(e=!0);var e,a,i=0;$(this).on("click",async function(t){t.preventDefault(),t.stopImmediatePropagation(),t.originalEvent.isTrusted&&(1==++i?a=setTimeout(async function(){(e&&!n[10]?v(n[9],n[7],t):await b(n[2],t))||L("Action failed."),i=0},350):(clearTimeout(a),(e?v(n[9],n[7],t):await b(n[2],t))?B(n[7]):L("Action failed."),i=0))}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})})}if(d){var k=z.processed[d];w(k),k[1]&&_(k)}else{if(n&&r.push(o),t){var y,C,x,T=t.match(M),[A,P]=[!1,!1],O=(!T.groups.handledomain||~location.hostname.indexOf(T.groups.handledomain)||(A=!0),[i]);n||O.push(o);for(y of O=O.filter((t,e)=>void 0!==t&&O.indexOf(t)==e))A?P||((C=await tt(location.protocol+"//"+location.hostname+"/"+t+"/"+y))&&(P=!0,r.push(C),F.test(C)?(x=C.match(F)).groups.handle&&x.groups.tootid&&x.groups.domain&&r.push(x.groups.domain+"/@"+x.groups.handle+"/"+x.groups.tootid):M.test(C)&&(x=C.match(M)).groups.handle&&x.groups.tootid&&x.groups.domain&&r.push(x.groups.domain+"/users/"+x.groups.handle+"/statuses/"+x.groups.tootid)),r.push(location.protocol+"//"+location.hostname+"/"+t+"/"+y)):(r.push(location.protocol+"//"+location.hostname+"/users/"+T.groups.handle+"/statuses/"+y),r.push(location.protocol+"//"+location.hostname+"/@"+T.groups.handle+"/"+y))}if(r.length){var D,S,R,U,E,I=!1;for(D of r=r.filter((t,e)=>r.indexOf(t)==e))I||([S,R]=await Z(D),S&&(I=!0,U="https://"+q.fediact_homeinstance+"/@"+S[0]+"/"+S[1],E=[s,...S,U,!0,...R,!1,D,c]));I?(d=H(E),w(E),_(E)):(L("Failed to resolve: "+r),d=H([s,!1]),w([s,!1]))}else L("Could not identify a post URI for home resolving."),d=H([s,!1]),w([s,!1])}}else L("Could not get toot data.")}}$(document).DOMNodeAppear(async function(t){z.isProcessing.includes($(t.target).get(0))||(z.isProcessing.push($(t.target).get(0)),e($(t.target)))},"div.status, div.detailed-status"),$(document).find("div.status, div.detailed-status").each(function(){z.isProcessing.includes($(this).get(0))||(z.isProcessing.push($(this).get(0)),e($(this)))})}async function at(){async function e(i){Y();var e,n,o,t,a,s,r,c,d="follow",l=$(i).siblings("button:has(i.fa-ellipsis-fw,i.fa-ellipsis-v,i.fa-ellipsis-h)");async function u(t){return q.fediact_autoaction?(t=await J(t,d,null),"follow"==d&&t?($(n).length?($(n).removeClass("fa-user-plus").addClass("fa-user"),$(i).append("-"),$(i).attr("title","Unfollow")):$(i).text("Unfollow"),d="unfollow",!0):"unfollow"==d&&t?($(n).length?($(n).removeClass("fa-user").addClass("fa-user-plus"),$(i).contents().filter((t,e)=>3===e.nodeType).remove(),$(i).attr("title","Follow")):$(i).text("Follow"),d="follow",!0):void 0):(L("Auto-action disabled."),!0)}if($(i).closest("div.account-card").length)e=$(i).closest("div.account-card").find("div.display-name > span").text().trim();else if($(i).closest("div.directory__card").length)e=$(i).closest("div.directory__card").find("div.display-name > span").text().trim(),n=W(i);else for(const f of p)if($(f).length){(e=$(f).text().trim()).split("@").length-1==1&&(e=e+"@"+z.exturi);break}e&&!z.processedFollow.includes(e)&&($("<span class='fediactprocessing'></span>").insertBefore($(i)),(o=await E(e))?(z.processedFollow.push(e),$(l).length&&$(l).removeClass("disabled").removeAttr("disabled"),t=e.split("@"),a=t.pop()||t.pop(),s="https://"+q.fediact_homeinstance+"/@"+o[1],(await U([o[0]]))[0]&&($(n).length?($(n).removeClass("fa-user-plus").addClass("fa-user"),$(i).append("-"),$(i).attr("title","Unfollow")):$(i).text("Unfollow"),d="unfollow"),$(l).on("click",function(t){t.preventDefault(),t.stopImmediatePropagation(),t.originalEvent.isTrusted&&(t=[],G(e)?t.push(["unblock",o[0],"Unblock user"]):t.push(["block",o[0],"Block user"]),j(e)?t.push(["unmute",o[0],"Unmute user"]):t.push(["mute",o[0],"Mute user"]),Q(e)?t.push(["domainunblock",a,"Unblock domain"]):t.push(["domainblock",a,"Block domain"]),t.push(["copy",s,"Copy home URL"]),K(t))}),r=0,$(i).on("click",async function(t){var e,a;t.preventDefault(),t.stopImmediatePropagation(),t.originalEvent.isTrusted&&(1==++r?c=setTimeout(async function(){u(o[0]),r=0},350):(clearTimeout(c),await u(o[0])?($(n).length?(e=$(n).attr("class"),$(n).removeClass("fa-user").removeClass("fa-user-plus").addClass("fa-arrow-right")):(a=$(i).text(),$(i).text("Redirecting...")),setTimeout(function(){B(s),$(n).length?$(n).attr("class",e):$(i).text(a)},1e3)):L("Action failed."),r=0))}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})):L("Could not resolve user home ID."),$(i).siblings(".fediactprocessing").remove())}var t=a.join(",");$(document).DOMNodeAppear(async function(t){z.isProcessing.includes($(t.target).get(0))||(z.isProcessing.push($(t.target).get(0)),e($(t.target)))},t),$(document).find(t).each(function(){z.isProcessing.includes($(this).get(0))||(z.isProcessing.push($(this).get(0)),e($(this)))})}function t(t){var e,a=[];for(e of t.split(/\r?\n/))(e=e.trim()).length&&(i.test(e)?a.push(e):L("Removed invalid domain "+e+" from blacklist/whitelist."));return[...new Set(a)]}function it(){if(null==q.fediact_homeinstance||!q.fediact_homeinstance)return L("Mastodon home instance is not set."),!1;if(!q.fediact_token)return L("No API token available. Are you logged in to your home instance? If yes, wait for 1-2 minutes and reload page."),!1;if(z.tokenheader={Authorization:"Bearer "+q.fediact_token},!i.test(q.fediact_homeinstance))return L("Instance setting is not a valid domain name."),!1;if("whitelist"==q.fediact_mode){if(z.whitelist=t(q.fediact_whitelist),z.whitelist.length<1)return L("Whitelist is empty or invalid."),!1}else z.blacklist=t(q.fediact_blacklist);return!0}async function nt(){if(location.hostname==q.fediact_homeinstance&&(z.fedireply=P("fedireply"),!z.fedireply))return L("Current site is your home instance."),!1;if("whitelist"==q.fediact_mode){if($.inArray(location.hostname,z.whitelist)<0)return L("Current site is not in whitelist."),!1}else if(-1<$.inArray(location.hostname,z.blacklist))return L("Current site is in blacklist."),!1;var t=location.protocol+"//"+location.hostname+o,t=await m("GET",t,null,null);return!!t&&!(!(t=JSON.parse(t).uri)||(t.startsWith("http")?(t=new URL(t),z.exturi=t.hostname):z.exturi=t,ot()?!q.fediact_runifloggedin&&!z.fedireply&&await A()&&(L("Already logged in to this external instance."),1):(L("Could not start background processor."),1)))}async function ot(){chrome.runtime.onMessage.addListener(async function(t,e,a){if(t.urlchanged){z.processed=[],z.processedFollow=[],z.isProcessing=[],$(".fediacticon").remove(),$(".fediactsettings_onsite").remove();try{$("body").off("click",fediSettingsHandler)}catch{$.noop()}await b()||location.reload()}t.updatedfedisettings&&location.reload()});try{return await chrome.runtime.sendMessage({running:!0}),!0}catch(t){L(t)}return!1}function b(){return new Promise(async function(e){try{q=await(browser||chrome).storage.local.get(y)}catch(t){return L(t),void e(!1)}q&&it()?e(!0):e(!1)})}async function st(){await b()?await nt()?(z.fedireply?I:(at(),N))():L("Will not process this site."):L("Could not load settings.")}st();