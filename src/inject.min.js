const n=["div.account__header button.logo-button","div.public-account-header a.logo-button","div.account-card a.logo-button","div.directory-card a.icon-button","div.detailed-status a.logo-button"],c=["div.account__header__tabs__name small","div.public-account-header__tabs__name small","div.detailed-status span.display-name__account","div.display-name > span"],i=/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/,D=/^(?<domain>https?:\/\/(?:\.?[a-z0-9-]+)+(?:\.[a-z]+){1})?\/?@(?<handle>\w+)(?:@(?<handledomain>(?:[\w-]+\.)+?\w+))?(?:\/(?<tootid>\d+))?\/?$/,N=/^(?<domain>https?:\/\/(?:\.?[a-z0-9-]+)+(?:\.[a-z]+){1})(?:\/users\/)(?<handle>\w+)(?:(?:\/statuses\/)(?<tootid>\d+))?\/?$/,e=!0,a="[FediAct]",k=200,o="/api/v1/instance",r="/api/v1/statuses",s="/api/v2/search",l="/api/v1/accounts",d=500,u=200;var browser,chrome,f,h,R={};const t={fediact_homeinstance:null,fediact_alert:!1,fediact_mode:"blacklist",fediact_whitelist:null,fediact_blacklist:null,fediact_target:"_self",fediact_autoaction:!0,fediact_token:null,fediact_showfollows:!0,fediact_redirects:!0,fediact_enabledelay:!0};var I=[];function M(t){e&&console.log(a+" "+t)}!function(n){n.fn.DOMNodeAppear=function(e,a){if(!a)return!1;n(document).on("animationstart webkitAnimationStart oanimationstart MSAnimationStart",function(t){"nodeInserted"==t.originalEvent.animationName&&n(t.target).is(a)&&"function"==typeof e&&e(t)})},jQuery.fn.onAppear=jQuery.fn.DOMNodeAppear}(jQuery);var p=function(t){for(var e,a=window.location.search.substring(1).split("&"),n=0;n<a.length;n++)if((e=a[n].split("="))[0]===t)return void 0===e[1]||decodeURIComponent(e[1]);return!1};async function m(n,i,o){var t,e;return~i.indexOf(R.fediact_homeinstance)&&R.fediact_enabledelay&&(t=Date.now(),(e=t-f)<d&&await new Promise(t=>{setTimeout(function(){t()},d-e)}),f=t),new Promise(function(t){let e=new XMLHttpRequest;if(e.open(n,i),e.timeout=3e3,o)for(var a in o)e.setRequestHeader(a,o[a]);e.onload=function(){200<=this.status&&this.status<300?t(e.responseText):t(!1)},e.onerror=function(){M("Request to "+i+" failed."),t(!1)},e.send()})}function g(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function v(t,e,a){return t.replace(new RegExp(g(e),"g"),a)}function P(t){var e;R.fediact_redirects?(R.fediact_alert&&alert("Redirecting..."),e=window.open(t,R.fediact_target),M("Redirected to "+t),e?e.focus():M("Could not open new window. Please allow popups for this website.")):M("Redirects disabled.")}async function S(t,e){if(R.fediact_autoaction){var a,n;switch(e){case"follow":a="https://"+R.fediact_homeinstance+l+"/"+t+"/follow",n=function(t){return t.following||t.requested};break;case"boost":a="https://"+R.fediact_homeinstance+r+"/"+t+"/reblog",n=function(t){return t.reblogged};break;case"favourite":a="https://"+R.fediact_homeinstance+r+"/"+t+"/favourite",n=function(t){return t.favourited};break;case"bookmark":a="https://"+R.fediact_homeinstance+r+"/"+t+"/bookmark",n=function(t){return t.bookmarked};break;case"unfollow":a="https://"+R.fediact_homeinstance+l+"/"+t+"/unfollow",n=function(t){return!t.following&&!t.requested};break;case"unboost":a="https://"+R.fediact_homeinstance+r+"/"+t+"/unreblog",n=function(t){return!t.reblogged};break;case"unfavourite":a="https://"+R.fediact_homeinstance+r+"/"+t+"/unfavourite",n=function(t){return!t.favourited};break;case"unbookmark":a="https://"+R.fediact_homeinstance+r+"/"+t+"/unbookmark",n=function(t){return!t.bookmarked};break;default:M("No valid action specified.")}if(a){var i=await m("POST",a,R.tokenheader);if(i&&n(JSON.parse(i)))return!0}M(e+" action failed.")}else M("Auto-action is disabled.")}async function b(t){var e="https://"+R.fediact_homeinstance+l+"/relationships?";for(const o of t)e+="id[]="+o.toString()+"&";var a=await m("GET",e,R.tokenheader),n=Array(t.length).fill(!1);if(a)for(var a=JSON.parse(a),i=0;i<t.length;i++)for(account of a)account.id==t[i]&&account.following&&(n[i]=!0);return n}async function w(t){t=await m("GET","https://"+R.fediact_homeinstance+l+"/search?q="+t+"&resolve=true&limit=1",R.tokenheader);return!(!t||!(t=JSON.parse(t))[0].id)&&[t[0].id,t[0].acct]}async function E(t){var t=await m("GET","https://"+R.fediact_homeinstance+s+"/?q="+t+"&resolve=true&limit=1",R.tokenheader);return!!t&&!((t=JSON.parse(t)).accounts.length||!t.statuses.length)&&[(t=t.statuses[0]).account.acct,t.id,t.reblogged,t.favourited,t.bookmarked]}function z(t){return!!t&&new Promise(async function(e){try{await chrome.runtime.sendMessage({url:t},function(t){e(t||!1)})}catch(t){M(t),M("Reloading page, extension likely got updated or reloaded."),location.reload()}})}function q(t,e,a){var n,i,o=$(t).toggleClass(a).hasClass(a);for(n of e)o?$(t).css(n[0],n[2]):"!remove"==n[1]?(i=v($(t).attr("style"),n[0]+": "+n[2]+";",""),$(t).attr("style",i)):$(t).css(n[0],n[1])}function T(t){for(const e of t)if($(e).length)return $(e).text().trim();return!1}function U(t){for(var e=0;e<I.length;e++)if(I[e][0]==t)return e;return!1}function J(t){I.push(t);t=I.length-u;0<t&&(I=I.splice(0,t))}async function _(){$(document).DOMNodeAppear(function(t){$(t.target).find("button:has(i.fa-reply), button:has(i.fa-reply-all)").click()},"div.detailed-status__action-bar")}async function x(){function O(t){var e;return!t.startsWith("http")||(e=new URL(t),location.hostname==e.hostname)?[!1,(t=t.split("/")).pop()||t.pop()]:[!0,t]}async function e(e){$(e).is("div.detailed-status")&&(e=$(e).closest("div.focusable"));var t=function(t){if($(t).find("span.display-name__account").length)return $(t).find("span.display-name__account").first().text().trim()}($(e)),a=(n=$(e),$(n).is(".detailed-status__wrapper")?(a=window.location.href.split("?")[0].split("/")).pop()||a.pop():$(n).attr("data-id")?$(n).attr("data-id").split("-").slice(-1)[0]:$(n).closest("article[data-id], div[data-id]").length?$(n).closest("article[data-id], div[data-id]").first().attr("data-id").split("-").slice(-1)[0]:void 0),[n,i]=(n=$(e),$(n).find("a.status__relative-time").length?O($(n).find("a.status__relative-time").first().attr("href").split("?")[0]):$(n).find("a.detailed-status__datetime").length?O($(n).find("a.detailed-status__datetime").first().attr("href").split("?")[0]):$(n).find("a.modal-button").length?O($(n).find("a.modal-button").first().attr("href").split("?")[0]):void 0),o=a||i;if(o){var r=[],s=U(o),c=$(e).find("button:has(i.fa-star), a.icon-button:has(i.fa-star)").first(),l=$(e).find("button:has(i.fa-retweet), a.icon-button:has(i.fa-retweet)").first(),d=$(e).find("button:has(i.fa-bookmark)").first(),u=$(e).find("button:has(i.fa-reply), button:has(i.fa-reply-all), a.icon-button:has(i.fa-reply), a.icon-button:has(i.fa-reply-all)").first();async function f(t,e){n=e,a=!1,$(n.currentTarget).children("i.fa-retweet").length?a=$(n.currentTarget).children("i.fa-retweet").hasClass("fediactive")?"unboost":"boost":$(n.currentTarget).children("i.fa-star").length?a=$(n.currentTarget).hasClass("fediactive")?"unfavourite":"favourite":$(n.currentTarget).children("i.fa-bookmark").length?a=$(n.currentTarget).hasClass("fediactive")?"unbookmark":"bookmark":$(n.currentTarget).attr("href")&&(~$(n.currentTarget).attr("href").indexOf("type=reblog")?a=$(n.currentTarget).hasClass("fediactive")?"unboost":"boost":~$(n.currentTarget).attr("href").indexOf("type=favourite")&&(a=$(n.currentTarget).hasClass("fediactive")?"unfavourite":"favourite"));var a,n=a;return n?await S(t,n)?("boost"==n||"unboost"==n?(q($(e.currentTarget).find("i"),[["color","!remove","rgb(140, 141, 255)"],["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive"),s&&(I[s][3]=!I[s][3])):"favourite"==n||"unfavourite"==n?(q($(e.currentTarget),[["color","!remove","rgb(202, 143, 4)"]],"fediactive"),s&&(I[s][4]=!I[s][4])):(q($(e.currentTarget),[["color","!remove","rgb(255, 80, 80)"]],"fediactive"),s&&(I[s][5]=!I[s][5])),!0):(M("Could not execute action on home instance."),!1):(M("Could not determine action."),!1)}function h(t){$(e).find(".feditriggered").remove(),t[1]?($(d).removeClass("disabled").removeAttr("disabled"),t[4]&&!$(c).hasClass("fediactive")&&q($(c),[["color","!remove","rgb(202, 143, 4)"]],"fediactive"),t[3]&&!$(l).find("i.fediactive").length&&q($(l).find("i"),[["color","!remove","rgb(140, 141, 255)"],["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive"),t[5]&&!$(d).hasClass("fediactive")&&q($(d),[["color","!remove","rgb(255, 80, 80)"]],"fediactive")):$("<span class='feditriggered' style='color: orange; padding-right: 10px; padding-left: 10px'>Unresolved</span>").insertAfter($(c))}function p(n){$(u).on("click",function(t){t.preventDefault(),t.stopImmediatePropagation(),P(n[6]+"?fedireply")}),$([c,l,d]).each(function(){var e,a=0;$(this).on("click",async function(t){t.preventDefault(),t.stopImmediatePropagation(),1==++a?e=setTimeout(async function(){await f(n[2],t)||M("Action failed."),a=0},350):(clearTimeout(e),await f(n[2],t)?P(n[6]):M("Action failed."),a=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})})}if(s){var m=I[s];h(m),m[1]&&p(m)}else{if(n&&r.push(i),t){var g,v,b,w=t.match(D),[_,y]=[!1,!1],k=(!w.groups.handledomain||~location.hostname.indexOf(w.groups.handledomain)||(_=!0),[a]);n||k.push(i);for(g of k=k.filter((t,e)=>void 0!==t&&k.indexOf(t)==e))_?y||((v=await z(location.protocol+"//"+location.hostname+"/"+t+"/"+g))&&(y=!0,r.push(v),N.test(v)?(b=v.match(N)).groups.handle&&b.groups.tootid&&b.groups.domain&&r.push(b.groups.domain+"/@"+b.groups.handle+"/"+b.groups.tootid):D.test(v)&&(b=v.match(D)).groups.handle&&b.groups.tootid&&b.groups.domain&&r.push(b.groups.domain+"/users/"+b.groups.handle+"/statuses/"+b.groups.tootid)),r.push(location.protocol+"//"+location.hostname+"/"+t+"/"+g)):(r.push(location.protocol+"//"+location.hostname+"/users/"+w.groups.handle+"/statuses/"+g),r.push(location.protocol+"//"+location.hostname+"/@"+w.groups.handle+"/"+g))}if(r.length){var T,x,A,C=!1;for(T of r=r.filter((t,e)=>r.indexOf(t)==e))C||(x=await E(T))&&(C=!0,A="https://"+R.fediact_homeinstance+"/@"+x[0]+"/"+x[1],fullEntry=[o,...x,A,!0]);C?(J(fullEntry),p(fullEntry),h(fullEntry)):(M("Failed to resolve: "+r),J([o,!1]),h([o,!1]))}else M("Could not identify a post URI for home resolving."),J([o,!1]),h([o,!1])}}else M("Could not get toot data.")}$(document).DOMNodeAppear(async function(t){e($(t.target))},"div.status, div.detailed-status")}async function A(){var e,a="follow";var t=n.join(",");$(document).DOMNodeAppear(async function(t){!async function(n){async function i(t){t=await S(t,a);return"follow"==a&&t?($(n).text("Unfollow"),a="unfollow",!0):"unfollow"==a&&t?($(n).text("Follow"),a="follow",!0):void 0}if($(n).closest("div.account-card").length)e=$(n).closest("div.account-card").find("div.display-name > span").text().trim();else for(const t of c)if($(t).length){e=$(t).text().trim();break}var o,r,s;e&&((o=await w(e))?(R.fediact_showfollows&&(await b([o[0]]))[0]&&($(n).text("Unfollow"),a="unfollow"),r=0,$(n).on("click",async function(t){var e,a;t.preventDefault(),t.stopImmediatePropagation(),1==++r?s=setTimeout(async function(){i(o[0]),r=0},350):(clearTimeout(s),await i(o[0])?(e=$(n).text(),a="https://"+R.fediact_homeinstance+"/@"+o[1],$(n).text("Redirecting..."),setTimeout(function(){P(a),$(n).text(e)},1e3)):M("Action failed."),r=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})):M("Could not resolve user home ID."))}($(t.target))},t)}function y(t){var e,a=[];for(e of t.split(/\r?\n/))(e=e.trim()).length&&(i.test(e)?a.push(e):M("Removed invalid domain "+e+" from blacklist/whitelist."));return[...new Set(a)]}function C(){if(null==R.fediact_homeinstance||!R.fediact_homeinstance)return M("Mastodon home instance is not set."),!1;if(!R.fediact_token)return M("No API token available. Are you logged in to your home instance? If yes, wait for 1-2 minutes and reload page."),!1;if(R.tokenheader={Authorization:"Bearer "+R.fediact_token},!i.test(R.fediact_homeinstance))return M("Instance setting is not a valid domain name."),!1;if("whitelist"==R.fediact_mode){if(R.fediact_whitelist=y(R.fediact_whitelist),R.fediact_whitelist.length<1)return M("Whitelist is empty or invalid."),!1}else R.fediact_blacklist=y(R.fediact_blacklist);return!0}async function O(){if(location.hostname!=R.fediact_homeinstance||(h=p("fedireply"))){if("whitelist"==R.fediact_mode){if($.inArray(location.hostname,R.fediact_whitelist)<0)return M("Current site is not in whitelist."),!1}else if(-1<$.inArray(location.hostname,R.fediact_blacklist))return M("Current site is in blacklist."),!1;var t=await m("GET",location.protocol+"//"+location.hostname+o,null);if(t)if(JSON.parse(t).uri)return!0;M("Does not look like a Mastodon instance.")}else M("Current site is your home instance.");return!1}async function j(){chrome.runtime.onMessage.addListener(function(t,e,a){t.urlchanged&&(I=[]),t.updatedfedisettings&&location.reload()});try{return await chrome.runtime.sendMessage({running:!0}),!0}catch(t){M(t)}return!1}async function F(){try{R=await(browser||chrome).storage.local.get(t)}catch(t){return M(t),!1}R?C()&&(await O()?h?_():j()?(A(),x()):M("Failed to initialize background script."):M("Will not process this site.")):M("Could not load settings.")}F();