const e=["div.account__header button.logo-button","div.public-account-header a.logo-button","div.account-card a.logo-button","div.directory-card a.icon-button","div.detailed-status a.logo-button"],o=["div.account__header__tabs__name small","div.public-account-header__tabs__name small","div.detailed-status span.display-name__account","div.display-name > span"],i=/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/,a=/^(https?:\/\/(www\.)?.*\..*?\/)((@\w+(@([\w-]+\.)+?\w+)?)|explore|following|followers)\/?(\d+)?\/?$/,t=/^(https?:\/\/(www\.)?.*\..*?\/)((@\w+(@([\w-]+\.)+?\w+)?)|explore|public|public\/local)\/?(\d+)?\/?$/,n=/^(?:https?:\/\/(www\.)?.*\..*?\/)(@\w+(?:@([\w-]+\.)+?\w+)?)\/\d+\/?$/,r=/^[^@]*@(?<handle>\w+)(@(?<handledomain>([\w-]+\.)+?\w+))?\/?$/,l=!0,s="[FediFollow]",M=200,f="/api/v1/instance",d="/api/v1/statuses",c="/api/v2/search",u="/api/v1/accounts",w=500;var browser,chrome,h,p={};const m={fedifollow_homeinstance:null,fedifollow_alert:!1,fedifollow_mode:"blacklist",fedifollow_whitelist:null,fedifollow_blacklist:null,fedifollow_target:"_self",fedifollow_autoaction:!0,fedifollow_token:null,fedifollow_showfollows:!0,fedifollow_redirects:!0,fedifollow_enabledelay:!0};var v=window.location.href;function g(t){l&&console.log(s+" "+t)}async function _(a,n,l){var t,e;return~n.indexOf(p.fedifollow_homeinstance)&&p.fedifollow_enabledelay&&(t=Date.now(),(e=t-h)<300&&await new Promise(t=>{setTimeout(function(){t()},w-e)}),h=t),new Promise(function(t,e){let o=new XMLHttpRequest;if(o.open(a,n),o.timeout=3e3,l)for(var i in l)o.setRequestHeader(i,l[i]);o.onload=function(){200<=this.status&&this.status<300?t(o.responseText):t(!1)},o.onerror=function(){e({status:this.status,statusText:o.statusText})},o.send()})}function b(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function y(t,e,o){return t.replace(new RegExp(b(e),"g"),o)}function k(t){var e;p.fedifollow_redirects?(p.fedifollow_alert&&alert("Redirecting..."),e=window.open(t,p.fedifollow_target),g("Redirected to "+t),e?e.focus():g("Could not open new window. Please allow popups for this website.")):g("Redirects disabled.")}async function T(t){if(p.fedifollow_autoaction){t=await _("POST","https://"+p.fedifollow_homeinstance+u+"/"+t+"/follow",p.tokenheader);if(t)return!(!(t=JSON.parse(t)).following&&!t.requested&&(g("Follow failed."),1))}else g("Auto-action disabled.")}async function A(t){if(p.fedifollow_autoaction){t=await _("POST","https://"+p.fedifollow_homeinstance+u+"/"+t+"/unfollow",p.tokenheader);if(t)return!(t=JSON.parse(t)).following&&!t.requested||(g("Unfollow failed."),!1)}else g("Auto-action disabled.")}async function O(t){if(p.fedifollow_autoaction){t=await _("POST","https://"+p.fedifollow_homeinstance+d+"/"+t+"/reblog",p.tokenheader);if(t)return!!JSON.parse(t).reblogged||(g("Boost failed."),!1)}else g("Auto-action disabled.")}async function x(t){if(p.fedifollow_autoaction){t=await _("POST","https://"+p.fedifollow_homeinstance+d+"/"+t+"/unreblog",p.tokenheader);if(t)return!JSON.parse(t).reblogged||(g("Unboost failed."),!1)}else g("Auto-action disabled.")}async function S(t){if(p.fedifollow_autoaction){t=await _("POST","https://"+p.fedifollow_homeinstance+d+"/"+t+"/favourite",p.tokenheader);if(t)return!!JSON.parse(t).favourited||(g("Favourite failed."),!1)}else g("Auto-action disabled.")}async function R(t){if(p.fedifollow_autoaction){t=await _("POST","https://"+p.fedifollow_homeinstance+d+"/"+t+"/unfavourite",p.tokenheader);if(t)return!JSON.parse(t).favourited||(g("Unfavourite failed."),!1)}else g("Auto-action disabled.")}async function E(t){var e="https://"+p.fedifollow_homeinstance+u+"/relationships?";for(const n of t)e+="id[]="+n.toString()+"&";var o=await _("GET",e,p.tokenheader),i=Array(t.length).fill(!1);if(o)for(var o=JSON.parse(o),a=0;a<t.length;a++)for(account of o)account.id==t[a]&&account.following&&(i[a]=!0);return i}async function U(t){t=await _("GET","https://"+p.fedifollow_homeinstance+u+"/search?q="+t,p.tokenheader);return!(!t||!(t=JSON.parse(t))[0].id)&&[t[0].id,t[0].acct]}function q(t){return!!t&&new Promise(e=>{chrome.runtime.sendMessage({url:t},function(t){e(t||!1)})})}async function N(t,e){var o,i,a,n,l,s=await _("GET","https://"+p.fedifollow_homeinstance+c+"/?q="+t+"&resolve=true&limit=10",p.tokenheader);return s?((s=JSON.parse(s)).accounts.length||s.statuses.length||!r.test(t)||(n=t.match(r)).groups.handle&&n.groups.handledomain&&(t="https://"+n.groups.handledomain+"/@"+n.groups.handle,s=await _("GET","https://"+p.fedifollow_homeinstance+c+"/?q="+t+"&resolve=true&limit=10",p.tokenheader),s=JSON.parse(s)),s.accounts.length&&!s.statuses.length?(l="https://"+p.fedifollow_homeinstance+"/@"+s.accounts[0].acct,"follow"==e?o=await T(s.accounts[0].id):"unfollow"==e&&(o=await A(s.accounts[0].id))):!s.accounts.length&&s.statuses.length&&(n=s.statuses[0],l="https://"+p.fedifollow_homeinstance+"/@"+n.account.acct+"/"+n.id,"boost"==e?o=await O(n.id):"favourite"==e?o=await S(n.id):"unboost"==e?o=await x(n.id):"unfavourite"==e&&(o=await R(n.id)),i=n.favourited,a=n.reblogged),!!l&&[l,o,i,a]):(g("API call failed..."),!1)}function P(t,e,o){var i,a,n=$(t).toggleClass(o).hasClass(o);for(i of e)n?$(t).css(i[0],i[2]):"!remove"==i[1]?(a=y($(t).attr("style"),i[0]+": "+i[2]+";",""),$(t).attr("style",a)):$(t).css(i[0],i[1])}function F(t,e,o,i){return o=o&&o.join(","),new MutationObserver(function(t){t.forEach(function(t){var e=t.addedNodes;null!==e&&$(e).each(function(){(!o||$(this).is(o))&&i(this,t)})})}).observe($(t)[0],e)}function j(t){for(const e of t)if($(e).length)return $(e).text().trim();return!1}async function C(){async function s(t,e){var o=function(t){var e=!1;$(t.currentTarget).children("i.fa-retweet").length?e=$(t.currentTarget).children("i.fa-retweet").hasClass("fediactive")?"unboost":"boost":$(t.currentTarget).children("i.fa-star").length?e=$(t.currentTarget).hasClass("fediactive")?"unfavourite":"favourite":$(t.currentTarget).attr("href")&&(~$(t.currentTarget).attr("href").indexOf("type=reblog")?e=$(t.currentTarget).hasClass("fediactive")?"unboost":"boost":~$(t.currentTarget).attr("href").indexOf("type=favourite")&&(e=$(t.currentTarget).hasClass("fediactive")?"unfavourite":"favourite"));return e}(e);if(o){t=await N(t,o);if(t)return t[1]&&("boost"==o||"unboost"==o?P($(e.currentTarget).find("i"),[["color","!remove","rgb(140, 141, 255)"],["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive"):P($(e.currentTarget),[["color","!remove","rgb(202, 143, 4)"]],"fediactive")),t[0];g("Could not resolve action on home instance.")}else g("Could not determine action.")}async function o(t){var e,o,i,a,n=location.protocol+"//"+location.hostname+"/",l=function(t){var e,[o,i]=[!1,!1];return $(t).find("span.display-name__account").length&&(i=$(t).find("span.display-name__account").text().trim()),$(t).is(".detailed-status__wrapper")?o=v.split("?")[0].split("/")[4]:$(t).find("a.status__relative-time").attr("href")?o=(e=$(t).find("a.status__relative-time").attr("href").split("?")[0]).startsWith("http")?e.split("/")[4]:e.split("/")[2]:$(t).find("a.detailed-status__datetime").attr("href")?o=(e=$(t).find("a.detailed-status__datetime").attr("href").split("?")[0]).startsWith("http")?e.split("/")[4]:e.split("/")[2]:$(t).attr("data-id")?o=$(t).attr("data-id").split("-").slice(-1)[0]:$(t).closest("article[data-id], div[data-id]").length?o=$(t).closest("article[data-id], div[data-id]")[0].attr("data-id").split("-").slice(-1)[0]:$(t).find("a.modal-button").length&&(o=(e=$(t).find("a.modal-button").attr("href").split("?")[0]).startsWith("http")?e.split("/")[4]:e.split("/")[2]),[o,i]}($(t));l?((o=l[1].match(r)).groups.handledomain?~location.hostname.indexOf(o.groups.handledomain)?(clearedHandle=l[1].split("@"+o.groups.handledomain)[0],n+=clearedHandle+"/"+l[0]):(e=await q(location.protocol+"//"+location.hostname+"/"+l[1]+"/"+l[0]),n=e||"https://"+o.groups.handledomain+"/@"+o.groups.handle+"/"+l[0]):n+=l[1]+"/"+l[0],n?(resolveAndAction=await N(n,null))?(e=$(t).find("button:has(i.fa-star), a.icon-button:has(i.fa-star)"),o=$(t).find("button:has(i.fa-retweet), a.icon-button:has(i.fa-retweet)"),resolveAndAction[2]&&!$(e).hasClass("fediactive")&&P($(e),[["color","!remove","rgb(202, 143, 4)"]],"fediactive"),resolveAndAction[3]&&!$(o).find("i.fediactive").length&&P($(o).find("i"),[["color","!remove","rgb(140, 141, 255)"],["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive"),i=0,$(e).add(o).on("click",async function(t){t.preventDefault(),t.stopImmediatePropagation(),1==++i?a=setTimeout(async function(){await s(n,t),i=0},350):(clearTimeout(a),(url=await s(n,t))&&k(url),i=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})):g("Failed to resolve: "+n):g("Could not identify a post URI for home resolving.")):g("Could not get toot data.")}t.test(v.split("?")[0])?n.test(v)?($(document).find("div.detailed-status__wrapper").each(function(){o($(this))}),$(document).DOMNodeAppear(async function(t){o($(t.target))},"div.status, div.detailed-status__wrapper")):($(document).ready(async function(){var i=$("body").html();await new Promise(e=>{var o=setInterval(function(){var t=$("body").html();t==i?(changing=!1,e(!0),clearInterval(o)):i=t},100)}),$(document).find("div.entry > div.status").each(function(){o($(this))})}),$(document).DOMNodeAppear(async function(t){var t=$(t.target),i=$("body").html();await new Promise(e=>{var o=setInterval(function(){var t=$("body").html();t==i?(changing=!1,e(!0),clearInterval(o)):i=t},100)}),t.find("div.status").each(async function(){document.body.contains($(this)[0])&&o($(this))}),F(t,{subtree:!0,childList:!0},["div.status"],function(t,e){o($(t))})},"article, div.entry > div.status")):g("There are no toots on this site")}async function I(){var t;a.test(v.split("?")[0])?(t=e.join(","),$(document).DOMNodeAppear(async function(t){!async function(a){var t,n,l,s,r="follow";if($(a).closest("div.account-card").length)t=$(a).closest("div.account-card").find("div.display-name > span").text().trim();else for(const e of o)if($(e).length){t=$(e).text().trim();break}t&&((n=await U(t))?(p.fedifollow_showfollows&&(await E([n[0]]))[0]&&($(a).text("Unfollow"),r="unfollow"),l=0,$(a).off(),$(a).unbind(),$(a).on("click",async function(t){var e,o,i;t.preventDefault(),t.stopImmediatePropagation(),1==++l?s=setTimeout(async function(){"follow"==r?await T(n[0])&&($(a).text("Unfollow"),r="unfollow"):await A(n[0])&&($(a).text("Follow"),r="follow"),l=0},350):(clearTimeout(s),"follow"==r?await T(n[0])&&($(a).text("Unfollow"),r="unfollow",e=!0):await A(n[0])&&($(a).text("Follow"),r="follow",e=!0),e?(o=$(a).text(),i="https://"+p.fedifollow_homeinstance+"/@"+n[1],$(a).text("Redirecting..."),setTimeout(function(){k(i),$(a).text(o)},1e3)):g("Action failed."),l=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})):g("Could not resolve user home ID."))}($(t.target))},t)):g("Not a profile URL.")}async function D(){setTimeout(function(){v!=window.location.href&&(v=window.location.href,I(),C()),D()},300)}function J(t){var e,o=[];for(e of t.split(/\r?\n/))e=e.trim(),i.test(e)?o.push(e):g("Removed invalid domain "+e+" from blacklist/whitelist.");return[...new Set(o)]}function G(){if(null==p.fedifollow_homeinstance||!p.fedifollow_homeinstance)return g("Mastodon home instance is not set."),!1;if(!p.fedifollow_token)return g("No API token available. Are you logged in to your home instance? If yes, wait for 1-2 minutes and reload page."),!1;if(p.tokenheader={Authorization:"Bearer "+p.fedifollow_token},!i.test(p.fedifollow_homeinstance))return g("Instance setting is not a valid domain name."),!1;if($.inArray(p.fedifollow_mode,["blacklist","whitelist"])<0&&(p.fedifollow_mode="blacklist"),$.inArray(p.fedifollow_target,["_blank","_self"])<0&&(p.fedifollow_target="_blank"),"whitelist"==p.fedifollow_mode){if(p.fedifollow_whitelist=J(p.fedifollow_whitelist),p.fedifollow_whitelist.length<1)return g("Whitelist is empty or invalid."),!1}else p.fedifollow_blacklist=J(p.fedifollow_blacklist);return!0}async function W(){if(location.hostname==p.fedifollow_homeinstance)g("Current site is your home instance.");else{if("whitelist"==p.fedifollow_mode){if($.inArray(location.hostname,p.fedifollow_whitelist)<0)return g("Current site is not in whitelist."),!1}else if(-1<$.inArray(location.hostname,p.fedifollow_blacklist))return g("Current site is in blacklist."),!1;var t=await _("GET",location.protocol+"//"+location.hostname+f,null);if(t)if(JSON.parse(t).uri)return!0;g("Does not look like a Mastodon instance.")}return!1}async function z(){(p=await(browser||chrome).storage.local.get(m))?G()&&(await W()?(I(),C(),D()):g("Will not process this site.")):g("Could not load settings.")}!function(i){i.fn.DOMNodeAppear=function(e,o){var t=i(this);if(!(o=o||"function"==typeof t.selector&&t.selector))return!1;i(document).on("animationstart webkitAnimationStart oanimationstart MSAnimationStart",function(t){"nodeInserted"==t.originalEvent.animationName&&i(t.target).is(o)&&"function"==typeof e&&e(t)})},jQuery.fn.onAppear=jQuery.fn.DOMNodeAppear}(jQuery),z();