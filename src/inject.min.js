const e=["div.account__header button.logo-button","div.public-account-header a.logo-button","div.account-card a.logo-button","div.directory-card a.icon-button","div.detailed-status a.logo-button"],a=["div.account__header__tabs__name small","div.public-account-header__tabs__name small","div.detailed-status span.display-name__account","div.display-name > span"],i=/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/,o=/^(https?:\/\/(www\.)?.*\..*?\/)((@\w+(@([\w-]+\.)+?\w+)?)|explore|following|followers)\/?(\d+)?\/?$/,t=/^(https?:\/\/(www\.)?.*\..*?\/)((@\w+(@([\w-]+\.)+?\w+)?)|explore|public|public\/local)\/?(\d+)?\/?$/,n=/^(?:https?:\/\/(www\.)?.*\..*?\/)(@\w+(?:@([\w-]+\.)+?\w+)?)\/\d+\/?$/,l=/^[^@]*@(?<handle>\w+)(@(?<handledomain>([\w-]+\.)+?\w+))?(\/(?<tootid>\d+))?\/?$/,r=!0,s="[FediAct]",J=200,c="/api/v1/instance",d="/api/v1/statuses",f="/api/v2/search",u="/api/v1/accounts",h=500;var browser,chrome,p,m,v={};const w={fediact_homeinstance:null,fediact_alert:!1,fediact_mode:"blacklist",fediact_whitelist:null,fediact_blacklist:null,fediact_target:"_self",fediact_autoaction:!0,fediact_token:null,fediact_showfollows:!0,fediact_redirects:!0,fediact_enabledelay:!0};var b=window.location.href;function g(t){r&&console.log(s+" "+t)}!function(i){i.fn.DOMNodeAppear=function(e,a){var t=i(this);if(!(a=a||"function"==typeof t.selector&&t.selector))return!1;i(document).on("animationstart webkitAnimationStart oanimationstart MSAnimationStart",function(t){"nodeInserted"==t.originalEvent.animationName&&i(t.target).is(a)&&"function"==typeof e&&e(t)})},jQuery.fn.onAppear=jQuery.fn.DOMNodeAppear}(jQuery);var _=function(t){for(var e,a=window.location.search.substring(1).split("&"),i=0;i<a.length;i++)if((e=a[i].split("="))[0]===t)return void 0===e[1]||decodeURIComponent(e[1]);return!1};async function y(o,n,r){var t,e;return~n.indexOf(v.fediact_homeinstance)&&v.fediact_enabledelay&&(t=Date.now(),(e=t-p)<h&&await new Promise(t=>{setTimeout(function(){t()},h-e)}),p=t),new Promise(function(t,e){let a=new XMLHttpRequest;if(a.open(o,n),a.timeout=3e3,r)for(var i in r)a.setRequestHeader(i,r[i]);a.onload=function(){200<=this.status&&this.status<300?t(a.responseText):t(!1)},a.onerror=function(){e({status:this.status,statusText:a.statusText})},a.send()})}function k(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function T(t,e,a){return t.replace(new RegExp(k(e),"g"),a)}function A(t){var e;v.fediact_redirects?(v.fediact_alert&&alert("Redirecting..."),e=window.open(t,v.fediact_target),g("Redirected to "+t),e?e.focus():g("Could not open new window. Please allow popups for this website.")):g("Redirects disabled.")}async function O(t){if(v.fediact_autoaction){t=await y("POST","https://"+v.fediact_homeinstance+u+"/"+t+"/follow",v.tokenheader);if(t)return!(!(t=JSON.parse(t)).following&&!t.requested&&(g("Follow failed."),1))}else g("Auto-action disabled.")}async function x(t){if(v.fediact_autoaction){t=await y("POST","https://"+v.fediact_homeinstance+u+"/"+t+"/unfollow",v.tokenheader);if(t)return!(t=JSON.parse(t)).following&&!t.requested||(g("Unfollow failed."),!1)}else g("Auto-action disabled.")}async function N(t){if(v.fediact_autoaction){t=await y("POST","https://"+v.fediact_homeinstance+d+"/"+t+"/reblog",v.tokenheader);if(t)return!!JSON.parse(t).reblogged||(g("Boost failed."),!1)}else g("Auto-action disabled.")}async function S(t){if(v.fediact_autoaction){t=await y("POST","https://"+v.fediact_homeinstance+d+"/"+t+"/unreblog",v.tokenheader);if(t)return!JSON.parse(t).reblogged||(g("Unboost failed."),!1)}else g("Auto-action disabled.")}async function M(t){if(v.fediact_autoaction){t=await y("POST","https://"+v.fediact_homeinstance+d+"/"+t+"/favourite",v.tokenheader);if(t)return!!JSON.parse(t).favourited||(g("Favourite failed."),!1)}else g("Auto-action disabled.")}async function U(t){if(v.fediact_autoaction){t=await y("POST","https://"+v.fediact_homeinstance+d+"/"+t+"/unfavourite",v.tokenheader);if(t)return!JSON.parse(t).favourited||(g("Unfavourite failed."),!1)}else g("Auto-action disabled.")}async function E(t){if(v.fediact_autoaction){t=await y("POST","https://"+v.fediact_homeinstance+d+"/"+t+"/bookmark",v.tokenheader);if(t)return!!JSON.parse(t).bookmarked||(g("Bookmark failed."),!1)}else g("Auto-action disabled.")}async function q(t){if(v.fediact_autoaction){t=await y("POST","https://"+v.fediact_homeinstance+d+"/"+t+"/unbookmark",v.tokenheader);if(t)return!JSON.parse(t).bookmarked||(g("Unbookmark failed."),!1)}else g("Auto-action disabled.")}async function F(t){var e="https://"+v.fediact_homeinstance+u+"/relationships?";for(const n of t)e+="id[]="+n.toString()+"&";var a=await y("GET",e,v.tokenheader),i=Array(t.length).fill(!1);if(a)for(var a=JSON.parse(a),o=0;o<t.length;o++)for(account of a)account.id==t[o]&&account.following&&(i[o]=!0);return i}async function j(t,e){var a;switch(e){case"boost":a=await N(t);break;case"favourite":a=await M(t);break;case"bookmark":a=await E(t);break;case"unboost":a=await S(t);break;case"unfavourite":a=await U(t);break;case"unbookmark":a=await q(t);break;default:g("No valid action specified.")}return a}async function W(t){t=await y("GET","https://"+v.fediact_homeinstance+u+"/search?q="+t+"&resolve=true&limit=1",v.tokenheader);return!(!t||!(t=JSON.parse(t))[0].id)&&[t[0].id,t[0].acct]}async function z(t){var t=await y("GET","https://"+v.fediact_homeinstance+f+"/?q="+t+"&resolve=true&limit=1",v.tokenheader);return t?!(t=JSON.parse(t)).accounts.length&&t.statuses.length?[(t=t.statuses[0]).account.acct,t.id,t.reblogged,t.favourited,t.bookmarked]:(g("No toot result found."),!1):(g("API call failed..."),!1)}function G(t){return!!t&&new Promise(e=>{chrome.runtime.sendMessage({url:t},function(t){e(t||!1)})})}function C(t,e,a){var i,o,n=$(t).toggleClass(a).hasClass(a);for(i of e)n?$(t).css(i[0],i[2]):"!remove"==i[1]?(o=T($(t).attr("style"),i[0]+": "+i[2]+";",""),$(t).attr("style",o)):$(t).css(i[0],i[1])}function L(t,e,a,i){return a=a&&a.join(","),new MutationObserver(function(t){t.forEach(function(t){var e=t.addedNodes;null!==e&&$(e).each(function(){(!a||$(this).is(a))&&i(this,t)})})}).observe($(t)[0],e)}function B(t){for(const e of t)if($(e).length)return $(e).text().trim();return!1}async function Q(){$(document).DOMNodeAppear(function(t){$(t.target).find("button:has(i.fa-reply), button:has(i.fa-reply-all)").click()},"div.detailed-status__action-bar")}async function P(){async function c(t,e){var a=function(t){var e=!1;$(t.currentTarget).children("i.fa-retweet").length?e=$(t.currentTarget).children("i.fa-retweet").hasClass("fediactive")?"unboost":"boost":$(t.currentTarget).children("i.fa-star").length?e=$(t.currentTarget).hasClass("fediactive")?"unfavourite":"favourite":$(t.currentTarget).children("i.fa-bookmark").length?e=$(t.currentTarget).hasClass("fediactive")?"unbookmark":"bookmark":$(t.currentTarget).attr("href")&&(~$(t.currentTarget).attr("href").indexOf("type=reblog")?e=$(t.currentTarget).hasClass("fediactive")?"unboost":"boost":~$(t.currentTarget).attr("href").indexOf("type=favourite")&&(e=$(t.currentTarget).hasClass("fediactive")?"unfavourite":"favourite"));return e}(e);return a?await j(t,a)?("boost"==a||"unboost"==a?C($(e.currentTarget).find("i"),[["color","!remove","rgb(140, 141, 255)"],["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive"):C($(e.currentTarget),"favourite"==a||"unfavourite"==a?[["color","!remove","rgb(202, 143, 4)"]]:[["color","!remove","rgb(255, 80, 80)"]],"fediactive"),!0):(g("Could not execute action on home instance."),!1):(g("Could not determine action."),!1)}async function a(t){var e,a,i,o,n,r,s=function(t){var e,[a,i]=[!1,!1];return $(t).find("span.display-name__account").length&&(closestTootAuthor=$(t).find("span.display-name__account").first().text().trim()),$(t).is(".detailed-status__wrapper")?a=b.split("?")[0].split("/")[4]:$(t).find("a.status__relative-time").attr("href")?(e=$(t).find("a.status__relative-time").attr("href").split("?")[0]).startsWith("http")?(new URL(e),location.hostname==e.hostname?a=e.split("/")[4]:(a=e,i=!0)):a=e.split("/")[2]:$(t).find("a.detailed-status__datetime").attr("href")?a=(e=$(t).find("a.detailed-status__datetime").attr("href").split("?")[0]).startsWith("http")?e.split("/")[4]:e.split("/")[2]:$(t).attr("data-id")?a=$(t).attr("data-id").split("-").slice(-1)[0]:$(t).closest("article[data-id], div[data-id]").length?a=$(t).closest("article[data-id], div[data-id]")[0].attr("data-id").split("-").slice(-1)[0]:$(t).find("a.modal-button").length&&(a=(e=$(t).find("a.modal-button").attr("href").split("?")[0]).startsWith("http")?e.split("/")[4]:e.split("/")[2]),[a,closestTootAuthor,i]}($(t));s?(console.log(s),s[2]?e=s[0]:!(a=s[1].match(l)).groups.handledomain||~location.hostname.indexOf(a.groups.handledomain)?e=location.protocol+"//"+location.hostname+"/users/"+a.groups.handle+"/statuses/"+s[0]:(a=await G(location.protocol+"//"+location.hostname+"/"+s[1]+"/"+s[0]))?~a.indexOf("/users/")?e=a:l.test(a)&&(i=a.match(l))&&(e=a.split("@")[0]+"users/"+i.groups.handle+"/statuses/"+i.groups.tootid):(g("Resolve fallback #1"),e=location.protocol+"//"+location.hostname+"/"+s[1]+"/"+s[0]),e?(a=$(t).find("button:has(i.fa-star), a.icon-button:has(i.fa-star)").first(),i=$(t).find("button:has(i.fa-retweet), a.icon-button:has(i.fa-retweet)").first(),s=$(t).find("button:has(i.fa-bookmark)").first(),o=$(t).find("button:has(i.fa-reply), button:has(i.fa-reply-all), a.icon-button:has(i.fa-reply), a.icon-button:has(i.fa-reply-all)").first(),(n=await z(e))?($(s).removeClass("disabled").removeAttr("disabled"),n[3]&&!$(a).hasClass("fediactive")&&C($(a),[["color","!remove","rgb(202, 143, 4)"]],"fediactive"),n[2]&&!$(i).find("i.fediactive").length&&C($(i).find("i"),[["color","!remove","rgb(140, 141, 255)"],["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive"),n[4]&&!$(s).hasClass("fediactive")&&C($(s),[["color","!remove","rgb(255, 80, 80)"]],"fediactive"),r="https://"+v.fediact_homeinstance+"/@"+n[0]+"/"+n[1],$(o).on("click",function(t){t.preventDefault(),t.stopImmediatePropagation(),A(r+"?fedireply")}),$([a,i,s]).each(function(){var e,a=0;$(this).on("click",async function(t){t.preventDefault(),t.stopImmediatePropagation(),1==++a?e=setTimeout(async function(){await c(n[1],t)||g("Action failed."),a=0},350):(clearTimeout(e),await c(n[1],t)?A(r):g("Action failed."),a=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})})):(g("Failed to resolve: "+e),console.log($(t)),console.log($(a)),$("<span style='color: orange; padding-right: 10px; padding-left: 10px'>Not resolved</span>").insertAfter($(a)))):g("Could not identify a post URI for home resolving.")):g("Could not get toot data.")}t.test(b.split("?")[0])?n.test(b)?($(document).find("div.detailed-status__wrapper").each(function(){a($(this))}),$(document).DOMNodeAppear(async function(t){a($(t.target))},"div.status, div.detailed-status__wrapper")):($(document).ready(async function(){var i=$("body").html();await new Promise(e=>{var a=setInterval(function(){var t=$("body").html();t==i?(changing=!1,e(!0),clearInterval(a)):i=t},100)}),$(document).find("div.entry > div.status").each(function(){a($(this))})}),$(document).DOMNodeAppear(async function(t){var t=$(t.target),i=$("body").html();await new Promise(e=>{var a=setInterval(function(){var t=$("body").html();t==i?(changing=!1,e(!0),clearInterval(a)):i=t},100)}),t.find("div.status").each(async function(){document.body.contains($(this)[0])&&a($(this))}),L(t,{subtree:!0,childList:!0},["div.status"],function(t,e){a($(t))})},"article, div.entry > div.status")):g("There are no toots on this site")}async function I(){var t;o.test(b.split("?")[0])?(t=e.join(","),$(document).DOMNodeAppear(async function(t){!async function(o){var t,n,r,s,c="follow";if($(o).closest("div.account-card").length)t=$(o).closest("div.account-card").find("div.display-name > span").text().trim();else for(const e of a)if($(e).length){t=$(e).text().trim();break}t&&((n=await W(t))?(v.fediact_showfollows&&(await F([n[0]]))[0]&&($(o).text("Unfollow"),c="unfollow"),r=0,$(o).off(),$(o).unbind(),$(o).on("click",async function(t){var e,a,i;t.preventDefault(),t.stopImmediatePropagation(),1==++r?s=setTimeout(async function(){"follow"==c?await O(n[0])&&($(o).text("Unfollow"),c="unfollow"):await x(n[0])&&($(o).text("Follow"),c="follow"),r=0},350):(clearTimeout(s),"follow"==c?await O(n[0])&&($(o).text("Unfollow"),c="unfollow",e=!0):await x(n[0])&&($(o).text("Follow"),c="follow",e=!0),e?(a=$(o).text(),i="https://"+v.fediact_homeinstance+"/@"+n[1],$(o).text("Redirecting..."),setTimeout(function(){A(i),$(o).text(a)},1e3)):g("Action failed."),r=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})):g("Could not resolve user home ID."))}($(t.target))},t)):g("Not a profile URL.")}async function D(){setTimeout(function(){b!=window.location.href&&(b=window.location.href,I(),P()),D()},300)}function R(t){var e,a=[];for(e of t.split(/\r?\n/))e=e.trim(),i.test(e)?a.push(e):g("Removed invalid domain "+e+" from blacklist/whitelist.");return[...new Set(a)]}function H(){if(null==v.fediact_homeinstance||!v.fediact_homeinstance)return g("Mastodon home instance is not set."),!1;if(!v.fediact_token)return g("No API token available. Are you logged in to your home instance? If yes, wait for 1-2 minutes and reload page."),!1;if(v.tokenheader={Authorization:"Bearer "+v.fediact_token},!i.test(v.fediact_homeinstance))return g("Instance setting is not a valid domain name."),!1;if($.inArray(v.fediact_mode,["blacklist","whitelist"])<0&&(v.fediact_mode="blacklist"),$.inArray(v.fediact_target,["_blank","_self"])<0&&(v.fediact_target="_blank"),"whitelist"==v.fediact_mode){if(v.fediact_whitelist=R(v.fediact_whitelist),v.fediact_whitelist.length<1)return g("Whitelist is empty or invalid."),!1}else v.fediact_blacklist=R(v.fediact_blacklist);return!0}async function X(){if(location.hostname!=v.fediact_homeinstance||(m=_("fedireply"))){if("whitelist"==v.fediact_mode){if($.inArray(location.hostname,v.fediact_whitelist)<0)return g("Current site is not in whitelist."),!1}else if(-1<$.inArray(location.hostname,v.fediact_blacklist))return g("Current site is in blacklist."),!1;var t=await y("GET",location.protocol+"//"+location.hostname+c,null);if(t)if(JSON.parse(t).uri)return!0;g("Does not look like a Mastodon instance.")}else g("Current site is your home instance.");return!1}async function K(){(v=await(browser||chrome).storage.local.get(w))?H()&&(await X()?(m?Q:(I(),P(),D))():g("Will not process this site.")):g("Could not load settings.")}K();