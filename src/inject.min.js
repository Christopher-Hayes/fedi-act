const i=["div.account__header button.logo-button","div.public-account-header a.logo-button","div.account-card a.logo-button","div.directory-card a.icon-button","div.detailed-status a.logo-button","button.remote-button","div.account__header button.button--follow"],c=["div.account__header__tabs__name small","div.public-account-header__tabs__name small","div.detailed-status span.display-name__account","div.display-name > span","a.user-screen-name","div.profile-info-panel small"],a=/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/,O=/^(?<domain>https?:\/\/(?:\.?[a-z0-9-]+)+(?:\.[a-z]+){1})?\/?@(?<handle>\w+)(?:@(?<handledomain>(?:[\w-]+\.)+?\w+))?(?:\/(?<tootid>\d+))?\/?$/,R=/^(?<domain>https?:\/\/(?:\.?[a-z0-9-]+)+(?:\.[a-z]+){1})(?:\/users\/)(?<handle>\w+)(?:(?:\/statuses\/)(?<tootid>\d+))?\/?$/,e=!0,n="[FediAct]",o="/api/v1/instance",s="/api/v1/statuses",r="/api/v2/search",d="/api/v1/accounts",l=500,f=200;var browser,chrome,u,p,N={};const t={fediact_homeinstance:null,fediact_alert:!1,fediact_mode:"blacklist",fediact_whitelist:null,fediact_blacklist:null,fediact_target:"_self",fediact_autoaction:!0,fediact_token:null,fediact_showfollows:!0,fediact_redirects:!0,fediact_enabledelay:!0,fediact_hidemuted:!1,fediact_mutesblocks:[],fediact_domainblocks:[]};var[z,h,m]=[[],[],[]];function D(t){e&&console.log(n+" "+t)}!function(a){a.fn.DOMNodeAppear=function(e,i){if(!i)return!1;a(document).on("animationstart webkitAnimationStart oanimationstart MSAnimationStart",function(t){"nodeInserted"==t.originalEvent.animationName&&a(t.target).is(i)&&"function"==typeof e&&e(t)})},jQuery.fn.onAppear=jQuery.fn.DOMNodeAppear}(jQuery);var g=function(t){for(var e,i=window.location.search.substring(1).split("&"),a=0;a<i.length;a++)if((e=i[a].split("="))[0]===t)return void 0===e[1]||decodeURIComponent(e[1]);return!1};async function v(a,n,o){var t,e;return~n.indexOf(N.fediact_homeinstance)&&N.fediact_enabledelay&&(t=Date.now(),(e=t-u)<l&&await new Promise(t=>{setTimeout(function(){t()},l-e)}),u=t),new Promise(function(t){let e=new XMLHttpRequest;if(e.open(a,n),e.timeout=3e3,o)for(var i in o)e.setRequestHeader(i,o[i]);e.onload=function(){200<=this.status&&this.status<300?t(e.responseText):t(!1)},e.onerror=function(){D("Request to "+n+" failed."),t(!1)},e.send()})}async function T(){var t=!1,e=location.protocol+"//"+location.hostname,e=await Promise.any([$.ajax(e+"/api/v1/instance"),$.ajax(e+"/api/v1/instance/settings"),$.ajax(e+"/nodeinfo/2.0.json"),$.ajax(e+"/nodeinfo/2.1.json"),$.ajax(e+"/api/nodeinfo/2.0.json"),$.ajax(e+"/api/nodeinfo/2.1.json"),$.ajax(e+"/nodeinfo/2.0"),$.ajax(e+"/nodeinfo/2.1"),$.ajax(e+"/api/nodeinfo/2.0"),$.ajax(e+"/api/nodeinfo/2.1")]);return e&&(e=JSON.stringify(e),/pleroma|akkoma|rebased/i.test(e)?(N.fediact_instancetype="pleroma",t=!0):/mastodon|hometown|ecko/i.test(e)?(N.fediact_instancetype="mastodon",t=!0):/misskey|calckey|groundpolis|foundkey|cherrypick/i.test(e)?(N.fediact_instancetype="misskey",t=!0):/gnusocial/i.test(e)?(N.fediact_instancetype="gnusocial",t=!0):/friendica/i.test(e)?(N.fediact_instancetype="friendica",t=!0):/diaspora/i.test(e)?(N.fediact_instancetype="diaspora",t=!0):/hubzilla/i.test(e)?(N.fediact_instancetype="hubzilla",t=!0):/peertube/i.test(e)?(N.fediact_instancetype="peertube",t=!0):/pixelfed/i.test(e)?(N.fediact_instancetype="pixelfed",t=!0):/plume/i.test(e)?(N.fediact_instancetype="plume",t=!0):/lemmy/i.test(e)?(N.fediact_instancetype="lemmy",t=!0):/kbin/i.test(e)?(N.fediact_instancetype="kbin",t=!0):/funkwhale/i.test(e)?(N.fediact_instancetype="funkwhale",t=!0):/bookwyrm/i.test(e)?(N.fediact_instancetype="bookwyrm",t=!0):/dolphin/i.test(e)?(N.fediact_instancetype="dolphin",t=!0):/acropolis/i.test(e)?(N.fediact_instancetype="acropolis",t=!0):/pubgate/i.test(e)?(N.fediact_instancetype="pubgate",t=!0):/contentnation/i.test(e)?(N.fediact_instancetype="contentnation",t=!0):/mitra/i.test(e)?(N.fediact_instancetype="mitra",t=!0):/gotosocial/i.test(e)?(N.fediact_instancetype="gotosocial",t=!0):/smithereen/i.test(e)?(N.fediact_instancetype="smithereen",t=!0):/zap/i.test(e)?(N.fediact_instancetype="zap",t=!0):/red/i.test(e)&&(N.fediact_instancetype="red",t=!0)),t}function _(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function b(t,e,i){return t.replace(new RegExp(_(e),"g"),i)}function P(t){var e;N.fediact_redirects?(N.fediact_alert&&alert("Redirecting..."),e=window.open(t,N.fediact_target),D("Redirected to "+t),e?e.focus():D("Could not open new window. Please allow popups for this website.")):D("Redirects disabled.")}async function I(t,e){var i,a;switch(e){case"follow":i="https://"+N.fediact_homeinstance+d+"/"+t+"/follow",a=function(t){return t.following||t.requested};break;case"boost":i="https://"+N.fediact_homeinstance+s+"/"+t+"/reblog",a=function(t){return t.reblogged};break;case"favourite":i="https://"+N.fediact_homeinstance+s+"/"+t+"/favourite",a=function(t){return t.favourited};break;case"bookmark":i="https://"+N.fediact_homeinstance+s+"/"+t+"/bookmark",a=function(t){return t.bookmarked};break;case"unfollow":i="https://"+N.fediact_homeinstance+d+"/"+t+"/unfollow",a=function(t){return!t.following&&!t.requested};break;case"unboost":i="https://"+N.fediact_homeinstance+s+"/"+t+"/unreblog",a=function(t){return!t.reblogged};break;case"unfavourite":i="https://"+N.fediact_homeinstance+s+"/"+t+"/unfavourite",a=function(t){return!t.favourited};break;case"unbookmark":i="https://"+N.fediact_homeinstance+s+"/"+t+"/unbookmark",a=function(t){return!t.bookmarked};break;default:D("No valid action specified.")}if(i){var n=await v("POST",i,N.tokenheader);if(n&&a(JSON.parse(n)))return!0}D(e+" action failed.")}async function y(t){var e="https://"+N.fediact_homeinstance+d+"/relationships?";for(const o of t)e+="id[]="+o.toString()+"&";var i=await v("GET",e,N.tokenheader),a=Array(t.length).fill(!1);if(i)for(var i=JSON.parse(i),n=0;n<t.length;n++)for(account of i)account.id==t[n]&&(account.following||account.requested)&&(a[n]=!0);return a}function M(t){if((t=t.startsWith("@")?t.slice(1):t).split("@").length-1==0&&(t=t+"@"+N.fediact_exturi),N.fediact_mutesblocks.includes(t)||N.fediact_domainblocks.includes(t.split("@")[1]))return!0}async function w(t){t=await v("GET","https://"+N.fediact_homeinstance+d+"/search?q="+t+"&resolve=true&limit=1",N.tokenheader);return!(!t||!(t=JSON.parse(t))[0].id)&&[t[0].id,t[0].acct]}async function q(t){var t=await v("GET","https://"+N.fediact_homeinstance+r+"/?q="+t+"&resolve=true&limit=1",N.tokenheader);return!!t&&!((t=JSON.parse(t)).accounts.length||!t.statuses.length)&&[(t=t.statuses[0]).account.acct,t.id,t.reblogged,t.favourited,t.bookmarked]}function U(t){return!!t&&new Promise(async function(e){try{await chrome.runtime.sendMessage({url:t},function(t){e(t||!1)})}catch(t){D(t),D("Reloading page, extension likely got updated or reloaded."),location.reload()}})}function S(t,e,i){var a,n,o=$(t).toggleClass(i).hasClass(i);for(a of e)o?$(t).css(a[0],a[2]):"!remove"==a[1]?(n=b($(t).attr("style"),a[0]+": "+a[2]+";",""),$(t).attr("style",n)):$(t).css(a[0],a[1])}function J(t){for(var e=0;e<z.length;e++)if(z[e][0]==t)return e;return!1}function E(t){z.push(t);t=z.length-f;0<t&&(z=z.splice(0,t))}async function A(){$(document).DOMNodeAppear(function(t){$(t.target).find("button:has(i.fa-reply), button:has(i.fa-reply-all)").click()},"div.detailed-status__action-bar")}async function C(){function j(t){var e;return!t.startsWith("http")||(e=new URL(t),location.hostname==e.hostname)?[!1,(t=t.split("/")).pop()||t.pop()]:[!0,t]}async function e(e){$(e).is("div.detailed-status")&&(e=$(e).closest("div.focusable"));var t=function(t){if($(t).find("span.display-name__account").length)return $(t).find("span.display-name__account").first().text().trim()}($(e));if(!function(t,e){if(N.fediact_hidemuted){var i,a=[],n=($(t).siblings(".status__prepend").length&&(i=$(t).siblings(".status__prepend").first(),$(i).find("a").attr("href"))&&a.push($(i).find("a").attr("href").split("?")[0]),$(t).find("span.h-card").each(function(){a.push($(this).find("a").attr("href").split("?")[0])}),[]);for(href of a){var o,s=href.split("/"),s=(s=s.pop()||s.pop()).slice(1);href.startsWith("http")&&(o=new URL(href)).hostname!=N.fediact_exturi&&o.hostname!=location.hostname?n.push(s+"@"+o.hostname):n.push(s+"@"+N.fediact_exturi)}return n.some(t=>N.fediact_mutesblocks.includes(t))||M(e)||n.some(t=>N.fediact_domainblocks.includes(t.split("@")[1]))?($(t).hide(),i&&$(i).hide(),1):void 0}}(e,t)){a=$(e);var i=$(a).is(".detailed-status__wrapper")?(i=window.location.href.split("?")[0].split("/")).pop()||i.pop():$(a).attr("data-id")?$(a).attr("data-id").split("-").slice(-1)[0]:$(a).closest("article[data-id], div[data-id]").length?$(a).closest("article[data-id], div[data-id]").first().attr("data-id").split("-").slice(-1)[0]:void 0,[a,n]=(a=$(e),$(a).find("a.status__relative-time").length?j($(a).find("a.status__relative-time").first().attr("href").split("?")[0]):$(a).find("a.detailed-status__datetime").length?j($(a).find("a.detailed-status__datetime").first().attr("href").split("?")[0]):$(a).find("a.modal-button").length?j($(a).find("a.modal-button").first().attr("href").split("?")[0]):void 0),o=i||n;if(o){var s=[],r=J(o),c=$(e).find("button:has(i.fa-star), a.icon-button:has(i.fa-star)").first(),d=$(e).find("button:has(i.fa-retweet), a.icon-button:has(i.fa-retweet)").first(),l=$(e).find("button:has(i.fa-bookmark)").first(),f=$(e).find("button:has(i.fa-reply), button:has(i.fa-reply-all), a.icon-button:has(i.fa-reply), a.icon-button:has(i.fa-reply-all)").first();async function u(t,e){if(!N.fediact_autoaction)return D("Auto-action disabled."),!0;a=e,i=!1,$(a.currentTarget).children("i.fa-retweet").length?i=$(a.currentTarget).children("i.fa-retweet").hasClass("fediactive")?"unboost":"boost":$(a.currentTarget).children("i.fa-star").length?i=$(a.currentTarget).hasClass("fediactive")?"unfavourite":"favourite":$(a.currentTarget).children("i.fa-bookmark").length?i=$(a.currentTarget).hasClass("fediactive")?"unbookmark":"bookmark":$(a.currentTarget).attr("href")&&(~$(a.currentTarget).attr("href").indexOf("type=reblog")?i=$(a.currentTarget).hasClass("fediactive")?"unboost":"boost":~$(a.currentTarget).attr("href").indexOf("type=favourite")&&(i=$(a.currentTarget).hasClass("fediactive")?"unfavourite":"favourite"));var i,a=i;if(a){if(await I(t,a))return"boost"==a||"unboost"==a?(S($(e.currentTarget),[["color","!remove","rgb(140, 141, 255)"]],"fediactive"),S($(e.currentTarget).find("i"),[["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive"),r&&(z[r][3]=!z[r][3])):"favourite"==a||"unfavourite"==a?(S($(e.currentTarget),[["color","!remove","rgb(202, 143, 4)"]],"fediactive"),S($(e.currentTarget).find("i"),[["animation","spring-rotate-out 1s linear","spring-rotate-in 1s linear"]],"fediactive"),r&&(z[r][4]=!z[r][4])):(S($(e.currentTarget),[["color","!remove","rgb(255, 80, 80)"]],"fediactive"),r&&(z[r][5]=!z[r][5])),!0;D("Could not execute action on home instance.")}else D("Could not determine action.")}function p(t){$(e).find(".feditriggered").remove(),t[1]?($(l).removeClass("disabled").removeAttr("disabled"),t[4]&&!$(c).hasClass("fediactive")&&(S($(c),[["color","!remove","rgb(202, 143, 4)"]],"fediactive"),S($(c).find("i"),[["animation","spring-rotate-out 1s linear","spring-rotate-in 1s linear"]],"fediactive")),t[3]&&!$(d).find("i.fediactive").length&&(S($(d),[["color","!remove","rgb(140, 141, 255)"]],"fediactive"),S($(d).find("i"),[["transition-duration","!remove","0.9s"],["background-position","!remove","0px 100%"]],"fediactive")),t[5]&&!$(l).hasClass("fediactive")&&S($(l),[["color","!remove","rgb(255, 80, 80)"]],"fediactive")):$("<span class='feditriggered' style='color: orange; padding-right: 10px; padding-left: 10px'>Unresolved</span>").insertAfter($(c))}function h(a){$(f).on("click",function(t){t.preventDefault(),t.stopImmediatePropagation(),P(a[6]+"?fedireply")}),$([c,d,l]).each(function(){var e,i=0;$(this).on("click",async function(t){t.preventDefault(),t.stopImmediatePropagation(),1==++i?e=setTimeout(async function(){await u(a[2],t)||D("Action failed."),i=0},350):(clearTimeout(e),await u(a[2],t)?P(a[6]):D("Action failed."),i=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})})}if(r){var m=z[r];p(m),m[1]&&h(m)}else{if(a&&s.push(n),t){var g,v,_,b=t.match(O),[y,w]=[!1,!1],k=(!b.groups.handledomain||~location.hostname.indexOf(b.groups.handledomain)||(y=!0),[i]);a||k.push(n);for(g of k=k.filter((t,e)=>void 0!==t&&k.indexOf(t)==e))y?w||((v=await U(location.protocol+"//"+location.hostname+"/"+t+"/"+g))&&(w=!0,s.push(v),R.test(v)?(_=v.match(R)).groups.handle&&_.groups.tootid&&_.groups.domain&&s.push(_.groups.domain+"/@"+_.groups.handle+"/"+_.groups.tootid):O.test(v)&&(_=v.match(O)).groups.handle&&_.groups.tootid&&_.groups.domain&&s.push(_.groups.domain+"/users/"+_.groups.handle+"/statuses/"+_.groups.tootid)),s.push(location.protocol+"//"+location.hostname+"/"+t+"/"+g)):(s.push(location.protocol+"//"+location.hostname+"/users/"+b.groups.handle+"/statuses/"+g),s.push(location.protocol+"//"+location.hostname+"/@"+b.groups.handle+"/"+g))}if(s.length){var x,T,A,C=!1;for(x of s=s.filter((t,e)=>s.indexOf(t)==e))C||(T=await q(x))&&(C=!0,A="https://"+N.fediact_homeinstance+"/@"+T[0]+"/"+T[1],fullEntry=[o,...T,A,!0]);C?(E(fullEntry),h(fullEntry),p(fullEntry)):(D("Failed to resolve: "+s),E([o,!1]),p([o,!1]))}else D("Could not identify a post URI for home resolving."),E([o,!1]),p([o,!1])}}else D("Could not get toot data.")}}$(document).DOMNodeAppear(async function(t){m.includes($(t.target).get(0))||(m.push($(t.target).get(0)),e($(t.target)))},"div.status, div.detailed-status"),$(document).find("div.status, div.detailed-status").each(function(){m.includes($(this).get(0))||(m.push($(this).get(0)),e($(this)))})}async function j(){async function e(a){var t,n,o,s,e="follow";async function r(t){return N.fediact_autoaction?(t=await I(t,e),"follow"==e&&t?($(a).text("Unfollow"),e="unfollow",!0):"unfollow"==e&&t?($(a).text("Follow"),e="follow",!0):void 0):(D("Auto-action disabled."),!0)}if($(a).closest("div.account-card").length)t=$(a).closest("div.account-card").find("div.display-name > span").text().trim();else for(const i of c)if($(i).length){(t=$(i).text().trim()).split("@").length-1==1&&(t=t+"@"+N.fediact_exturi);break}t&&!h.includes(t)&&((n=await w(t))?(h.push(t),N.fediact_showfollows&&(await y([n[0]]))[0]&&($(a).text("Unfollow"),e="unfollow"),o=0,$(a).on("click",async function(t){var e,i;t.preventDefault(),t.stopImmediatePropagation(),1==++o?s=setTimeout(async function(){r(n[0]),o=0},350):(clearTimeout(s),await r(n[0])?(e=$(a).text(),i="https://"+N.fediact_homeinstance+"/@"+n[1],$(a).text("Redirecting..."),setTimeout(function(){P(i),$(a).text(e)},1e3)):D("Action failed."),o=0)}).on("dblclick",function(t){t.preventDefault(),t.stopImmediatePropagation()})):D("Could not resolve user home ID."))}var t=i.join(",");$(document).DOMNodeAppear(async function(t){m.includes($(t.target).get(0))||(m.push($(t.target).get(0)),e($(t.target)))},t),$(document).find(t).each(function(){m.includes($(this).get(0))||(m.push($(this).get(0)),e($(this)))})}function k(t){var e,i=[];for(e of t.split(/\r?\n/))(e=e.trim()).length&&(a.test(e)?i.push(e):D("Removed invalid domain "+e+" from blacklist/whitelist."));return[...new Set(i)]}function W(){if(null==N.fediact_homeinstance||!N.fediact_homeinstance)return D("Mastodon home instance is not set."),!1;if(!N.fediact_token)return D("No API token available. Are you logged in to your home instance? If yes, wait for 1-2 minutes and reload page."),!1;if(N.tokenheader={Authorization:"Bearer "+N.fediact_token},!a.test(N.fediact_homeinstance))return D("Instance setting is not a valid domain name."),!1;if("whitelist"==N.fediact_mode){if(N.fediact_whitelist=k(N.fediact_whitelist),N.fediact_whitelist.length<1)return D("Whitelist is empty or invalid."),!1}else N.fediact_blacklist=k(N.fediact_blacklist);return!0}async function L(){if(location.hostname!=N.fediact_homeinstance||(p=g("fedireply"))){if("whitelist"==N.fediact_mode){if($.inArray(location.hostname,N.fediact_whitelist)<0)return D("Current site is not in whitelist."),!1}else if(-1<$.inArray(location.hostname,N.fediact_blacklist))return D("Current site is in blacklist."),!1;var t=await v("GET",location.protocol+"//"+location.hostname+o,null);if(t){t=JSON.parse(t).uri;if(t)return t.startsWith("http")?(t=new URL(t),N.fediact_exturi=t.hostname):N.fediact_exturi=t,!0}D("Does not look like a Mastodon instance.")}else D("Current site is your home instance.");return!1}async function F(){chrome.runtime.onMessage.addListener(async function(t,e,i){t.urlchanged&&(z=[],h=[],m=[],await x()||location.reload()),t.updatedfedisettings&&location.reload()});try{return await chrome.runtime.sendMessage({running:!0}),!0}catch(t){D(t)}return!1}function x(){return new Promise(async function(e){try{N=await(browser||chrome).storage.local.get(t)}catch(t){D(t),e(!1)}N&&W()?e(!0):e(!1)})}async function G(){await x()?await L()?p?A():F()?(j(),C()):D("Failed to initialize background script."):D("Will not process this site."):D("Could not load settings.")}G();