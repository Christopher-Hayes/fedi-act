var browser,chrome,n;const a=!0,c="[FediAct]",t=1,i="/api/v1/mutes",s="/api/v1/blocks",o="/api/v1/domain_blocks",r=/"access_token":".*?",/gm,d={fediact_homeinstance:null,fediact_showfollows:!0,fediact_hidemuted:!1};function f(t){a&&console.log(c+" "+t)}async function h(a){return new Promise(async function(e){try{var t=await fetch(a,{method:"HEAD"});t.redirected?e(t.url):e(!1)}catch(t){f(t),e(!1)}})}async function u(){var t="https://"+n.fediact_homeinstance;try{var e=await(await fetch(t)).text()}catch(t){return f(t),!1}if(e){t=e.match(r);if(t){var e=t[0].search(/"access_token":"/),a=t[0].search(/",/);if(-1<e&&-1<a){t=t[0].substring(e+=16,a);if(16<t.length)return n.fediact_token=t,!0}}}n.fediact_token=null,f("Token could not be found.")}async function l(){var t,e,a;n.fediact_hidemuted&&([n.fediact_mutesblocks,n.fediact_domainblocks]=[[],[]],[t,e,a]=await Promise.all([fetch("https://"+n.fediact_homeinstance+i,{headers:{Authorization:"Bearer "+n.fediact_token}}).then(t=>t.json()),fetch("https://"+n.fediact_homeinstance+s,{headers:{Authorization:"Bearer "+n.fediact_token}}).then(t=>t.json()),fetch("https://"+n.fediact_homeinstance+o,{headers:{Authorization:"Bearer "+n.fediact_token}}).then(t=>t.json())]),t.length&&n.fediact_mutesblocks.push(...t.map(t=>t.acct)),e.length&&n.fediact_mutesblocks.push(...e.map(t=>t.acct)),n.fediact_mutesblocks=n.fediact_mutesblocks.filter((t,e)=>n.fediact_mutesblocks.indexOf(t)==e),a.length)&&(n.fediact_domainblocks=a)}async function m(){try{n=await(browser||chrome).storage.local.get(d)}catch(t){return f(t),!1}n.fediact_homeinstance?(await u(),await l()):f("Home instance not set");try{await(browser||chrome).storage.local.set(n)}catch{f(e)}}async function _(){chrome.tabs.query({},async function(t){for(var e=0;e<t.length;++e)try{await chrome.tabs.sendMessage(t[e].id,{updatedfedisettings:!0})}catch(t){continue}})}chrome.runtime.onInstalled.addListener(m),chrome.alarms.create("refresh",{periodInMinutes:t}),chrome.alarms.onAlarm.addListener(m),chrome.runtime.onMessage.addListener((t,n,e)=>{if(t.url)return h(t.url).then(e),!0;t.updatedsettings&&(m(),_()),t.running&&chrome.tabs.onUpdated.addListener(async function(t,e,a){if(t===n.tab.id&&e.url)try{await chrome.tabs.sendMessage(t,{urlchanged:e.url})}catch(t){f(t)}})});