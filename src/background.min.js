var browser,chrome,i;const t=!0,a="[FediAct]",n=1,c="/api/v1/mutes",s="/api/v1/blocks",o="/api/v1/domain_blocks",r=/"access_token":".*?",/gm,d={fediact_homeinstance:null,fediact_showfollows:!0,fediact_hidemuted:!1};function f(e){t&&console.log(a+" "+e)}async function u(a){return new Promise(async function(t){try{var e=await fetch(a,{method:"HEAD"});e.redirected?t(e.url):t(!1)}catch(e){f(e),t(!1)}})}async function h(){return new Promise(async function(t){var e="https://"+i.fediact_homeinstance;try{var a=await(await fetch(e)).text()}catch(e){return f(e),void t(!1)}if(a){e=a.match(r);if(e){var a=e[0].search(/"access_token":"/),n=e[0].search(/",/);if(-1<a&&-1<n){e=e[0].substring(a+=16,n);if(16<e.length)return i.fediact_token=e,void t(!0)}}}i.fediact_token=null,f("Token could not be found."),t(!1)})}async function l(){return new Promise(async function(e){var t,a,n;i.fediact_hidemuted&&([i.fediact_mutesblocks,i.fediact_domainblocks]=[[],[]],[t,a,n]=await Promise.all([fetch("https://"+i.fediact_homeinstance+c,{headers:{Authorization:"Bearer "+i.fediact_token}}).then(e=>e.json()),fetch("https://"+i.fediact_homeinstance+s,{headers:{Authorization:"Bearer "+i.fediact_token}}).then(e=>e.json()),fetch("https://"+i.fediact_homeinstance+o,{headers:{Authorization:"Bearer "+i.fediact_token}}).then(e=>e.json())]),t.length&&i.fediact_mutesblocks.push(...t.map(e=>e.acct)),a.length&&i.fediact_mutesblocks.push(...a.map(e=>e.acct)),i.fediact_mutesblocks=i.fediact_mutesblocks.filter((e,t)=>i.fediact_mutesblocks.indexOf(e)==t),n.length)&&(i.fediact_domainblocks=n),e(!0)})}async function m(){return new Promise(async function(t){try{i=await(browser||chrome).storage.local.get(d)}catch(e){return f(e),void t(!1)}if(i.fediact_homeinstance){await h(),await l();try{await(browser||chrome).storage.local.set(i),t(!0)}catch{f(e)}}else f("Home instance not set"),t(!1)})}async function _(){var e=await chrome.tabs.query({});if(e.length)for(var t=0;t<e.length;++t)try{chrome.tabs.sendMessage(e[t].id,{updatedfedisettings:!0})}catch(e){continue}}chrome.runtime.onInstalled.addListener(m),chrome.alarms.create("refresh",{periodInMinutes:n}),chrome.alarms.onAlarm.addListener(m),chrome.runtime.onMessage.addListener((e,n,t)=>e.url?(u(e.url).then(t),!0):e.updatedsettings?(m().then(_),!0):void(e.running&&chrome.tabs.onUpdated.addListener(async function(e,t,a){if(e===n.tab.id&&t.url)try{await chrome.tabs.sendMessage(e,{urlchanged:t.url})}catch(e){f(e)}})));